---
title: "Cypressã§Reduxã‚¹ãƒˆã‚¢ãŒæ›´æ–°ã—ãªã„å•é¡Œ"
emoji: "ğŸ« "
type: "tech"
topics:
  - "react"
  - "test"
  - "redux"
  - "cypress"
published: true
published_at: "2023-05-14 09:37"
---

# redux store ã¸ã‚¢ã‚¯ã‚»ã‚¹

ã¨ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® E2E ãƒ†ã‚¹ãƒˆã§ Cypress ã‚’å°å…¥ã—ã¦ã„ã¦ã€ã¨ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ã¯ã€ä¸€ã¤ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ CRUD æ“ä½œã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

ã“ã® CRUD æ“ä½œã«ã‚ˆã£ã¦ã€react ã®ã‚¹ãƒ†ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œã€ã•ã‚‰ã« UI ã«åæ˜ ã•ã‚Œã¦ã„ãæµã‚Œã§ã™ã€‚

ãŸã ã€é€šå¸¸ react ã®ã‚¹ãƒ†ãƒ¼ãƒˆã®æ›´æ–°ã«ã‚ˆã‚‹ã€ç”»é¢ã®å¤‰åŒ–ã¨ã„ã†ã®ã¯ã€HTML è¦ç´ ã‚’ Cypress ã® API ã§ç°¡å˜ã«ç¢ºèªã¯ã§ãã¾ã™ãŒã€ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã¯è‹¥å¹²ç‰¹æ®Šã§ã€HTML è¦ç´ ã®å¤‰åŒ–ãŒã•ã‚Œãšã€WebGL ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«æç”»ã•ã‚Œã‚‹ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã«ã€ç›´æ¥ HTML è¦ç´ ã®å¤‰åŒ–ãŒç¢ºèªã§ããªã„ã®ã§ã€è¿‚å›ç­–ã¨ã—ã¦ Redux ã®ã‚¹ãƒˆã‚¢ã®å¤‰åŒ–ã‚’è¦‹ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰å´

Cypress ä¸Šã§ã€redux store ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€ã¾ãšã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰å†…ã«`store`ã‚’`window`ã«ãã£ã¤ã‘ã‚‹ã“ã¨ã§ã™ã€‚

```ts
import React from "react";
import { Provider as StoreProvider } from "react-redux";

const store = createStore(reducer);

const App = () => {
  return <StoreProvider store={store}>{/* <...> */}</StoreProvider>;
};

if (window.Cypress) {
  window.store = store;
}

export default App;
```

ts ã§æ›¸ãå ´åˆã€`Window`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«`Cypress`ã‚„`store`ãŒå­˜åœ¨ã—ãªã„ã®ã§ã€`@ts-ignore`ã™ã‚‹ã‹ã€åˆ¥é€”ã‚¿ã‚¤ãƒ—å®£è¨€ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts
// global.d.ts
declare global {
  interface Window {
    Cypress?: Record<string, any>;
    store?: Record<string, any>;
  }
}

export {};
```

## Cypressã‚³ãƒ¼ãƒ‰å´

æ¬¡ã« Cypress å´ã§ã€ã‚¹ãƒˆã‚¢ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œã‚Šã¾ã™ã€‚

```ts
// support/commands.ts
import "@testing-library/cypress/add-commands";

Cypress.Commands.add("getReduxStore", (key: string) => {
  return cy
    .window()
    .its("store")
    .invoke("getState")
    .then((state) => cy.wrap(state[key]));
});

// global.d.ts

/// <reference types="cypress"/>

declare namespace Cypress {
  interface Chainable {
    getReduxStore(key: string): Chainable<Record<string, any>>;
  }
}
```

ã“ã‚Œã§ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å†…ã§ã¯ã€`cy.getReduxStore('key')`ã®å½¢ã§ã€ã‚¹ãƒˆã‚¢ã®ãƒ‡ãƒ¼ã‚¿ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

# actions ä¸Šã§ã‚¹ãƒ†ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œãªã„å•é¡Œ

ã“ã®å•é¡Œã«ã‹ãªã‚Šå›°ã£ã¦ã„ã¾ã—ãŸã€‚ã‚¹ãƒ†ãƒ¼ãƒˆã®å‰å¾Œã®å¤‰åŒ–ã‚’è¦³æ¸¬ã™ã‚‹ã®ã§ã€2 å›`getReduxStore`ã‚’å‘¼ã³å‡ºã—ã¾ã™ãŒã€2 å›ç›®ã®å‘¼ã³å‡ºã—ã«ã‚¹ãƒ†ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œãªã„å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

```ts
cy.intercept("DELETE", url).as("deleteResource");
// get state before update
cy.getReduxStore("data").then(({ list }) => {
  const lengthBefore = list.length;

  // CRUD operation ...

  cy.wait("@deleteResource").then((interception) => {
    const { request, response } = interception;
    // request succeeded
    expect(response.statusCode).eq(200);

    // check state updated
    cy.getReduxStore("data").then(({ list }) => {
      expect(list.length).eq(lengthBefore - 1); // -> failed here
      // other assertions...
    });
  });
});
```

ã“ã®å•é¡Œã¯ã€github actions ä¸Šå®Ÿè¡Œã™ã‚‹æ™‚ã«ã»ã¼ 100%ã®ç¢ºç‡ã§å‡ºä¼šã„ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰å†ç¾ã§ããšã€actions ä¸Šã®ãƒ‡ãƒãƒƒã‚°ã‚‚ã‹ãªã‚Šãƒãƒ¼ãƒ‰ãªã®ã§ã€è§£æ±ºã™ã‚‹ã¾ã§ã‹ãªã‚Šæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã—ãŸã€‚

ã¨ã„ã†æ™‚ã«[ ã“ã¡ã‚‰ã®è¨˜äº‹ ](https://www.cypress.io/blog/2018/11/14/testing-redux-store/)ã¨å‡ºä¼šã„ã¾ã—ãŸã€‚

A problem ã®ç¯€ã§è¿°ã¹ã¦ã„ã‚‹ã‚ˆã†ã«ã€ä»®ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‡¦ç†ã§ delay ãŒç”Ÿã˜ãŸå ´åˆã€2 å›ç›®ã«ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã«å¿…ãšã—ã‚‚æ›´æ–°ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã¨ã€‚è¨˜äº‹ã®ä¾‹ã®ã‚ˆã†ã«ã€å®Ÿéš›ã« timeout ã‚’ã¤ã‘ã¦å¼·å¼•ã«é…å»¶ã•ã›ã‚‹ã¨å†ç¾å¯èƒ½ãªå•é¡Œã§ã™ã€‚

## Cypress ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

Cypress ã®ã»ã¨ã‚“ã©ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€å‘¼ã³å‡ºã•ã‚ŒãŸæ™‚ã«å¾…ã¡æ™‚é–“ãŒè¨­ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ï¼ˆ[ ã“ã¡ã‚‰ ](https://docs.cypress.io/guides/core-concepts/introduction-to-cypress#Timeouts)ï¼‰ã€‚

ä¾‹ãˆã°ã€`cy.get()`ã® API ã«ã¯ã€å–å¾—æ“ä½œ â†’ è¦ç´ ãŒå­˜åœ¨ã™ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¨ã„ã†ãƒ­ã‚¸ãƒƒã‚¯ã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã™ã‚‹ã¨ã€å³æ™‚ã«ãƒ†ã‚¹ãƒˆå¤±æ•—ã¨ãªã‚‹ã‚ã‘ã§ã¯ãªãã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®æ™‚é–“ã¾ã§ãƒªãƒˆãƒ©ã‚¤ã—ç¶šã‘ã¾ã™ã€‚

Cypress ã‚’ä½¿ã†ã¨ã“ã®æ©Ÿèƒ½ãŒå½“ãŸã‚Šå‰ã®ã‚ˆã†ã«æ€ã£ã¦ã—ã¾ã„ãŒã¡ã§ã™ãŒã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®ãªã„ã€ã‚‚ã—ãã¯ãƒªãƒˆãƒ©ã‚¤ã§ããªã„ API ã‚‚å­˜åœ¨ã™ã‚‹ã®ã§ã™ã€‚

ä¾‹ãˆã°ã€ä¸Šè¨˜ã®`getReduxStore`ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹`invoke`ãŒãã‚Œã«ã‚ãŸã‚Šã¾ã™ã€‚ã¨ã„ã†ã®ã¯ã€`invoke`ã§å‘¼ã³å‡ºã•ã‚ŒãŸå‡¦ç†ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤‰ãˆã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ _å®‰å…¨ã«ãƒªãƒˆãƒ©ã‚¤_ ã™ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§ã™ã€‚

çµæœçš„ã«ã€ã“ã®å ´åˆã ã¨ã€`getReduxStore`ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯ä¸€å›åˆ‡ã‚Šã®ã‚‚ã®ã§ã€ç¶™ç¶šã™ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒãƒƒãƒã™ã‚‹ã¾ã§æ›´æ–°ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

## ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼‘ãƒ¼å¾…ã¤

ã“ã‚Œã¾ã§ã®å•é¡Œã‚’æ•´ç†ã™ã‚‹ã¨ã€å•é¡Œã¯ 2 ã¤ã®è¦ç´ ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é…å»¶ã§ã‚¹ãƒ†ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œãªã„
- `invoke`API ã«ãƒªãƒˆãƒ©ãƒ¼ã¯ãªã„ãŸã‚ã€`getReduxStore`ã®å€¤ã¯æ›´æ–°ã•ã‚Œãªã„

è¦ç´  1 ã‹ã‚‰è€ƒãˆã‚‹æœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªè§£æ±ºç­–ã¨ã—ã¦ã€æ›´æ–°ã™ã‚‹ã¾ã§`wait`ã‚³ãƒãƒ³ãƒ‰ã‚’é€šã—ã¦å¾…ã¦ã°è‰¯ã„ã€ã¨ã®ã“ã¨ã§ã™ã€‚

```ts
cy.intercept("DELETE", url).as("deleteResource");
// get state before update
cy.getReduxStore("data").then(({ list }) => {
  const lengthBefore = list.length;

  // CRUD operation ...

  cy.wait("@deleteResource").then((interception) => {
    const { request, response } = interception;
    // request succeeded
    expect(response.statusCode).eq(200);

    // wait 2secs before checking state updated
    cy.wait(2000)
      .getReduxStore("data")
      .then(({ list }) => {
        expect(list.length).eq(lengthBefore - 1);
        // other assertions...
      });
  });
});
```

ã“ã‚Œã§å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã‚‹ã¨ã€ç¢ºã‹ã« actions ä¸Šã§ã‚‚é€šã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

ã—ã‹ã—ã“ã‚Œã¯æ ¹æœ¬çš„ãªè§£æ±ºã«ãªã£ã¦ã„ã¾ã›ã‚“ã€‚ä»®ã« 2 ç§’ã§è¶³ã‚Šãªã‹ã£ãŸã‚‰å¤±æ•—ã™ã‚‹ã—ã€æ“ä½œã«ã‚ˆã£ã¦å¾…ã¡æ™‚é–“ãŒå‰å¾Œã™ã‚‹ã—ã€ç„¡é§„ãªå¾…ã¡æ™‚é–“ãŒå¢—ãˆã‚‹ã—ã€ä¸å®‰è¦ç´ ãŒå¤šã™ãã¾ã™ã€‚ã•ã‚‰ã«ã€å…¬å¼çš„ã«ã‚‚ã€ä»»æ„ã®æ™‚é–“ã‚’å¾…ã¤ã“ã¨ã‚’ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã—ã¦è–¦ã‚ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ[ã“ã¡ã‚‰](https://docs.cypress.io/api/commands/wait#Wait-for-an-arbitrary-period-of-milliseconds)ï¼‰ã€‚

## ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼’ãƒ¼ãƒªãƒˆãƒ©ã‚¤

ã“ã“ã¯ã‚„ã¯ã‚Šã€å•é¡Œã®è¦ç´  2 ã‹ã‚‰è€ƒãˆã¦ã€Cypress ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã‚‹ã‚³ãƒãƒ³ãƒ‰ã«ã™ã‚Œã°è‰¯ã„ã€ã¨ã®æ–¹å‘ã§ã™ã€‚

å¹¸ã„ã€ã“ã®ãƒªãƒˆãƒ©ã‚¤å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®[ ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ](https://github.com/NicholasBoll/cypress-pipe)ãŒã‚ã‚Šã¾ã—ãŸã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€`should`ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒç¶šã„ã¦ã„ã‚‹å ´åˆã€ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‘ã‚¹ã™ã‚‹ã‚‚ã—ãã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãªã‚‹ã¾ã§ãƒªãƒˆãƒ©ãƒ¼ã™ã‚‹ã‚ˆã€ã¨ã®ã“ã¨ã§ã™ã€‚

> AND is followed by a cy.should, the function will be retried until the assertion passes or times out (most Cypress commands do this)

ã¤ã¾ã‚Šã€æ¬¡ã®ã‚ˆã†ã«å¤‰ãˆã¦ãŠãã¨ã€`cy.getReduxStore('data').should(...)`ã®å½¢ã§å‘¼ã³å‡ºã›ã°ã€ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```ts
Cypress.Commands.add("getReduxStore", (key: string) => {
  const getState = (win: Cypress.AUTWindow) => win.store.getState()?.[key];
  return cy.window().pipe(getState);
});
```

ãŸã ã€ã‚¹ãƒˆã‚¢ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯é€šå¸¸è¤‡æ•°ã®ã‚­ãƒ¼ã€ãƒã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€æ¯å›ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®`store`ã‚’å–å¾—ã—ã¦ã‚‚ã€`should`ã‚’æ›¸ãã®ãŒå¤§å¤‰ã§ã™ã€‚ãã‚Œã‚’å¯¾å¿œã™ã‚‹ãŸã‚ã«ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å°‘ã—æ”¹å–„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```ts
Cypress.Commands.add("getReduxStore", (key: string) => {
  const getNestedValue = (obj: Record<string, any>, key: string) =>
    key.split(".").reduce((acc, cur) => acc?.[cur], obj);
  const getState = (win: Cypress.AUTWindow) => {
    const state = win.store.getState();
    return getNestedValue(state, key);
  };
  return cy.window().pipe(getState);
});
```

ãã‚Œã§ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ã¯ã€`cy.getReduxStore('data.list').should('have.length', lengthBefore - 1)`ã¨ã‹ã§ä½¿ãˆã¾ã™ã€‚

ã“ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã¯ã‚ã‚‹ç¨®ã€ä¿é™ºã‚’ã‹ã‘ã¦ã„ã‚‹ã“ã¨ãªã®ã§ã€ä»®ã«ã‚‚ã£ã¨è©³ç´°ãªãƒã‚§ãƒƒã‚¯ã‚’ã—ãŸã„å ´åˆã€ãã®ç›´å¾Œã§ã‚„ã‚Œã°è‰¯ã„ã¨ã®ã“ã¨ã§ã™ã€‚

```ts
cy.intercept("DELETE", url).as("deleteResource");
// get state before update
cy.getReduxStore("data").then(({ list }) => {
  const lengthBefore = list.length;

  // CRUD operation ...

  cy.wait("@deleteResource").then((interception) => {
    const { request, response } = interception;
    // request succeeded
    expect(response.statusCode).eq(200);

    // make sure the state is updated
    cy.getReduxStore("data.list").should("have.length", lengthBefore - 1);
    // extra detailed assertions
    cy.getReduxStore("data.list").then((list) => {
      expect(list.length).eq(lengthBefore - 1);
      // other assertions...
    });
  });
});
```

# çµ‚ã‚ã‚Šã«

ä»Šå›ã¯ Cypress ã§ redux store ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¨ãã®å•é¡Œã®è§£æ±ºç­–ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã—ãŸã€‚ã‚‚ã—ä»Šå›ã®å•é¡Œã®ã‚ˆã†ã«ã€ã€Œã‚¹ãƒ†ãƒ¼ãƒˆãŒæ›´æ–°ã•ã‚Œã¦ãªã„ï¼Ÿï¼ã€ã¨ã‹ã¨å‡ºä¼šã£ãŸã‚‰ã€ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ãªå½¢ã«å¤‰æ›ã—ã¦ã¿ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã§ã¯ã§ã¯ã€‚
