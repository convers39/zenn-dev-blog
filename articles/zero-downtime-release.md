---
title: "SPAã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ãƒªãƒªãƒ¼ã‚¹"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["react","SPA","devops"]
published: false
---


## çµŒç·¯

### ãªãœãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ç„¡ã—ç›®æŒ‡ã™ã®ã‹

ä¸€ã¤å¤§äº‹ãªè¦å› ã¨ã—ã¦ã€toBã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã®ã§ã€åœæ­¢ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã«ã¯ãŠå®¢æ§˜ã®åˆ©ç”¨æ™‚é–“ã‚’é¿ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãã‚Œã¯é€šå¸¸æ·±å¤œã¾ãŸã¯æ—©æœã«ãªã‚ŠãŒã¡ã§ã™ã€‚ã•ã‚‰ã«ãŠå®¢æ§˜ãŒå¢—ãˆã‚‹ã¨ã€ã“ã®æ·±å¤œæ—©æœã«ä»®ã«åˆ©ç”¨ã™ã‚‹ãŠå®¢æ§˜ãŒã„ã‚‹ã¨ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã™ã‚‰è¦‹ã¤ã‹ã‚‰ãªããªã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰ã¾ã ã•ã»ã©çµŒã£ã¦ã„ãªã„ã®ã§ã€æ—©ã„ã†ã¡ã§ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ç„¡ã—ã§ãƒªãƒªãƒ¼ã‚¹ã‚’é”æˆã—ãªã„ã¨ã€ä»Šå¾Œã®é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã«å¤§ããªæ”¯éšœãŒå‡ºã‚‹ã‹ã­ã¾ã›ã‚“ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒªãƒ¼ã‚¹ã¯ã€ä»¥å‰ç´¹ä»‹ã—ãŸ[ CloudRun Service + Jobsã®ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚·ãƒ§ãƒ³ ](https://zenn.dev/optimind/articles/7fefd01bbd8905)ã§é”æˆã§ãã¦ã„ã¾ã™ãŒã€ä»Šå›ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãªã—ã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã®ãŒç›®çš„ã§ã™ã€‚


### ç¾è±¡

SPAã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿ãªã„ãƒªãƒªãƒ¼ã‚¹ã€ã„ã‚ã°ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã®ãƒªãƒªãƒ¼ã‚¹ï¼ˆå³å¯†ã«ã¯100%ä¸€è‡´ã™ã‚‹ã‚ã‘ã§ã¯ãªã„ãŒï¼‰ã™ã‚‹ã«ã¯ã€æ€ã£ãŸã‚ˆã‚Šå•é¡ŒãŒå„ä»‹ã§ã—ãŸã€‚

ä½•ã‹ã¨ã„ã†ã¨ã€ã“ã¡ã‚‰ã®[ã‚¹ãƒ¬ãƒƒãƒ‰](https://github.com/vitejs/vite/issues/11804)ã«ã‚‚ã‚ã£ãŸã‚ˆã†ã« ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨ä¸­ã«ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã—ã¾ã†ã¨ã€ä¸‹è¨˜ã®ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã§ããªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```
TypeError: Failed to fetch dynamically imported module
```


### ç’°å¢ƒ

ã•ã¦ã€ã“ã®ç¾è±¡ãŒèµ·ã“ã£ã¦ã„ãŸã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç’°å¢ƒã‚’ç´¹ä»‹ã—ã¾ã™ã€‚


```json
{
    "node": "20.11.1",
    "vite": "4.3.9",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "@tanstack/react-query": "^4.28.0",
    "@trpc/client": "^10.21.0",
    "@trpc/react-query": "^10.21.0",
    ...
}
```

ãªãŠã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Firebase Hostingã«ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã“ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‘¨ã‚Šã®è¨­å®šãŒçµ¡ã‚“ã§ã„ã‚‹ã®ã§ã™ãŒã€å†…å®¹ã«é–¢ã—ã¦ã¯ä»–ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚‚å‚è€ƒã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚

## åŸå› 

[ã“ã¡ã‚‰](https://github.com/vitejs/vite/issues/11804)ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ã™ã§ã«è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã®ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿã®æµã‚Œã¨ã—ã¦ã€

- verAã®ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒverAã‚’åˆ©ç”¨ä¸­
- ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ã€verBã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢é·ç§»ã‚’ã™ã‚‹
- `Failed to fetch dynamically imported module`ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
- ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã¯æ¶ˆãˆãªã„

ã“ã“ã§ã„ãã¤ã‹ã®è¦ç´ ã‚’ã¾ãšæ•´ç†ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

- chunkåŒ–ã¨lazy load: ä¸€ã¤å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚ˆã‚Šã€å°ã•ãåˆ†å‰²ã—ã¦ã€å¿…è¦ãªæ™‚ã ã‘ãƒ•ã‚¡ã‚¤ãƒ«ã‚’éƒ½åº¦å–å¾—ã™ã‚‹æ–¹é‡ã¨ãªã‚Šã¾ã™ã€‚vite(rollup)ã¯ã‚‚ã¡ã‚ã‚“ã€ã»ã¨ã‚“ã©ã®ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’chunkåŒ–ã—ã¦ã„ã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ã‚’é–‹ãæ™‚ã«ã€é·ç§»å…ˆã‚‚ã—ãã¯ç¾åœ¨ç”»é¢ä¸Šã«è¡¨ç¤ºã™ã‚‹å¿…è¦ã®ãªã„ã‚‚ã®ãŒã‚ã‚Œã°ã€ä¸€æ—¦ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ãªã©ã‚’ä¿æŒã—ã¦ã€**å¿…è¦ã¨ãªã£ãŸæ™‚ã«ã¾ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹**ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
- å‘½åã®ãƒãƒƒã‚·ãƒ¥å€¤: ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«ã¤ã‘ã‚‹ã“ã¨ã§ã™(e.g. `Component.abc.js`)ã€‚ã‚³ãƒ¼ãƒ‰ã‚’å¤‰ãˆã‚‹ã¨ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚‚å¤‰ã‚ã‚Šã¾ã™(e.g. `Component.def.js`)ã€‚ãŸã ã€ã“ã‚Œã¯å˜ã«ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ã©ã†ã‹ãŒã‚ã‹ã‚‹ã ã‘ã§ã¯ãªãã€**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã™ã¹ãã‹ã©ã†ã‹ã®æŒ‡é‡**ã«ã‚‚ãªã£ã¦ãã‚Œã¾ã™ã€‚
- ãƒªãƒªãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°: ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã¯ã€åˆ©ç”¨ä¸­ã«æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã‚‰ã€ã¨ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚‚é‡è¦ã§ã™ã€‚**åˆ©ç”¨ä¸­ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒã‚·ãƒ¥å€¤å¤‰æ›´ã«ã‚ˆã‚Šã€å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªããªã‚‹**ã®ã§ã™ã€‚ã“ã“ã§ç”»é¢é·ç§»ã™ã‚‹ã¨å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚
- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°: ã“ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå¾Œã€ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚åŒã˜å•é¡Œã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„æ™‚ã«ã€ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãªã«ã‹ã—ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿”ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ãã®**ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æ™‚é–“ãŒåˆ‡ã‚Œã‚‹ã¾ã§ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚æ¶ˆãˆãªã„**ã®ã§ã™ï¼ˆã‚‚ã—ãã¯devtoolã‹ã‚‰disable cacheã«ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼‰ã€‚

ã™ã‚‹ã¨ã€è§£æ±ºã®æ–¹å‘æ€§ã‚‚ãªã‚“ã¨ãªãã‚ã‹ã£ã¦ãã¾ã™ã€‚

- ç”»é¢ãƒ­ãƒ¼ãƒ‰ã®åŠ¹ç‡åŒ–ã‚„ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¤å®šãªã©ã®ç›®çš„ã‹ã‚‰ã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯chunkåŒ–ã•ã‚Œã€ã‹ã¤å†…å®¹å¤‰æ›´ã™ã‚‹ãŸã³ã«ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¤‰ã‚ã‚‹å‰æã«ã—ãŸã„([ ãƒãƒƒã‚·ãƒ¥ã‚’æŠœã„ã¦ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´ã—ãªã„ ](https://stackoverflow.com/questions/69614671/vite-without-hash-in-filename)ã‚ˆã†ã«ã™ã‚‹ã®ã¯é‚ªé“ã¨ã¿ãªã™)
- æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸã€ã¨ã„ã†æƒ…å ±ã‚’ã‚¢ãƒ—ãƒªå´ã§æŒã¤ã‚ˆã†ã«ã—ãŸã„
- æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œçŸ¥ã—ãŸã‚‰ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã‚¹ãƒ ãƒ¼ã‚ºã«ç§»è¡Œã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„
- ã‚‚ã—ãã¯ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚ã—ã°ã‚‰ãå‹•ã‘ã‚‹ã‚ˆã†ã«ã—ãŸã„
- ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªã„ã‚ˆã†ã«ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãªã©è¨­å®šã‚’èª¿æ•´ã—ãŸã„


## è§£æ±ºãƒˆãƒ©ã‚¤ï¼‘ãƒ¼Service Worker

ã“ã‚Œã¯çœŸã£å…ˆã«ãã¾ã—ãŸã€‚ã‚ˆãä»–ã®ã‚¢ãƒ—ãƒªã§è¦‹ã‚‰ã‚ŒãŸã‚Šã—ã¾ã™ãŒã€ã€Œã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€çš„ãªãƒˆãƒ¼ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå³ä¸‹ã«å‡ºã¦ãã¦ã€ãã‚Œã§ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ç”»é¢ãŒãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãªã‚Šã¾ã™ï¼ˆ[ å‚è€ƒè¨˜äº‹ ](https://medium.com/progressive-web-apps/pwa-create-a-new-update-available-notification-using-service-workers-18be9168d717)ï¼‰ã€‚ãã‚Œã§æ—©é€Ÿèª¿æŸ»ã¨å®Ÿé¨“ã‚’å§‹ã‚ã¾ã—ãŸã€‚çµè«–ã‹ã‚‰è¨€ã†ã¨ã€è§£æ±ºã«ã¯è‡³ã‚‰ãªã‹ã£ãŸãŒã€è‰¯ãçµŒé¨“ã¨å­¦ã³ã«ãªã‚Šã¾ã—ãŸã€‚

### èƒŒæ™¯çŸ¥è­˜

ã¾ãšã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã¨ã¯ä½•ã‹ã‚’è»½ãã¾ã¨ã‚ã¾ã™ã€‚

- clientï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ï¼‰ã¨serverå´ã«ä»‹åœ¨ã™ã‚‹ä»£ç†/proxy
  - clientã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ãƒˆã™ã‚‹
  - clientã®main threadã¸é€šçŸ¥ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ãŒå¯èƒ½ -> ã“ã“é‡è¦
  - serverã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹
  - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
- ãƒ¯ãƒ¼ã‚«ãƒ¼ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€DOMã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ãªã„
  - ã¨ã¯ã„ãˆã€serviceWorkerã¨main threadã®é–“ã«é€šä¿¡ãŒå¯èƒ½ãªãŸã‚ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã‚ˆã£ã¦DOMæ“ä½œã‚„é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆãªã©ã‚’å«ã‚ã‚‹ç”»é¢ä¸Šã®æ“ä½œãŒå¯èƒ½
- ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦ã€Œãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã€ã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ãªãï¼‰
  - SWã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œãªã„
  - ãƒšãƒ¼ã‚¸ã®ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼ˆç”»é¢ãƒ¬ãƒ³ãƒ€ãƒ¼ãªã©ã‚’æ‹…ã†main threadã‹ã‚‰å®Œå…¨ç‹¬ç«‹ï¼‰
  - ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã•ã‚ŒãŸã‚‰è¤‡æ•°ã®ç”»é¢ï¼ˆã‚¿ãƒ–ï¼‰ã§åˆ©ç”¨ã§ãã€ã‚¿ãƒ–ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¦ã‚‚ãªããªã‚‰ãªã„
- httpsã¾ãŸã¯localhostã—ã‹ä½¿ãˆãªã„

ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®[ ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ« ](https://developer.chrome.com/docs/workbox/service-worker-lifecycle)ã‚„è©³ã—ã„ä½¿ã„æ–¹ã¯ã“ã“ã§å‰²æ„›ã—ã¾ã™ãŒã€ä¸€è¨€ã«è¨€ãˆã°ã€**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãªã©ã‚’æ‹…å½“ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã¨é€šä¿¡å¯èƒ½ãªãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚ã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã¨ã‚µãƒ¼ãƒãƒ¼ã®é–“ã«ä»‹åœ¨ã™ã‚‹ä»£ç†ã§ã‚ã‚‹**ã€ã¨èªè­˜ãŒã‚ã‚Œã°ååˆ†ã‹ã¨ã€‚


### ã©ã†è§£æ±ºã™ã‚‹ã‹

SWã§ã©ã†è¨€ã†ãµã†ã«ã“ã®å•é¡Œã‚’è§£æ±ºã§ãã‚‹ã‹ã¨è¨€ã†ã¨ã€ä¸»ã«**æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œçŸ¥**ã«æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€

- service workerã®updatefoundã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ©ç”¨ã—ã¦ã€service workerã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹
- service workerãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°è‡ªä½“ã¯ã€ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã¨é–¢ä¿‚ãªã„ãŒã€ãƒªãƒªãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰åº¦ã«ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ãŒå¤‰ã‚ã‚‹ãŸã‚ã€ãã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’service workerã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ã¨ã€æ›´æ–°ã®ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã¯æˆç«‹ã™ã‚‹
- æ›´æ–°ãŒã‚ã‚‹ã¨åˆ†ã‹ã£ãŸã‚‰ã€service workerã‹ã‚‰ç”»é¢ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Šã€ã‚¢ãƒ—ãƒªã‚³ãƒ¼ãƒ‰ã§æ›´æ–°ã®é€šçŸ¥ã‚’å‡ºã™

æ›´æ–°ã®é€šçŸ¥ã‚’å‡ºã™ã‹ã©ã†ã‹ã¯UIUXã®é ˜åŸŸã§è­°è«–ã™ã‚‹ä½™åœ°ã¯ã¾ã ã‚ã‚Šã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‹•ãã‚’æ¡ˆå†…ã™ã‚‹ã‚ˆã‚Šã€å®Œå…¨ã«è£å´ã§é»™ã€…ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹æ–¹æ³•ã‚‚å­˜åœ¨ã—ã¾ã™ï¼ˆ[å‚è€ƒè¨˜äº‹](https://dev.to/atonchev/flawless-and-silent-upgrade-of-the-service-worker-2o95)ï¼‰ã€‚ã„ãšã‚Œã«ã—ã¦ã‚‚ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼çµŒç”±ã§æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ¤œçŸ¥ãŒé”æˆã§ãã‚Œã°ã€å¾Œã¯ç°¡å˜ã«ãªã‚Šã¾ã™ã€‚


### ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å¯¾å¿œçŠ¶æ³

APIè‡ªä½“ã¯ãã‚Œã»ã©ã«æ–°ã—ã„ã‚ã‘ã§ã¯ãªã„ãŒã€å¿µã®ç‚ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã„ãŸæ–¹ãŒè‰¯ã„ï¼ˆ2024/06/30æ™‚ç‚¹ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/970336acf905-20240630.png)

### ServiceWorkerã‚’Reactã¸å°å…¥

ã“ã“ã§ã¯ä¸»ã«2ã¤ã®ãƒ«ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™ã€‚

ä¸€ã¤ã¯[ Viteã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ ](https://vite-pwa-org.netlify.app/guide/register-service-worker)ï¼ˆä¸­èº«ã¯[ workbox ](https://github.com/GoogleChrome/workbox)ãªã®ã§ã€ç›´æ¥workboxã‚’ä½¿ã†ã®ã‚‚åŒã˜ãƒ«ãƒ¼ãƒˆã¨ã—ã¦ã¿ãªã™ï¼‰ã€‚Reactç”¨ã®[ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé€šçŸ¥ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ](https://vite-pwa-org.netlify.app/frameworks/react.html#prompt-for-update)ã¾ã§ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã¾ã™ã®ã§ã€æ‰‹å–ã‚Šæ—©ãå®Ÿè£…ã—ãŸã„å ´åˆã¯ã“ã¡ã‚‰æ–­ç„¶ãŠã™ã™ã‚ã§ã™ã€‚

ã‚‚ã†ä¸€ã¤ã¯Vanilla JSã€‚ä»Šå›ã¯å‹‰å¼·ã‚‚ã‹ã­ã¦ã“ã¡ã‚‰ã«ã—ã¾ã—ãŸï¼ˆã¨è¨€ã†ã®ã¯å»ºå‰ã§ã€å®Ÿè£…ãŒçµ‚ã‚ã£ã¦ã‹ã‚‰viteã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’çŸ¥ã‚Šã¾ã—ãŸï¼‰ã€‚ä¸»ã«[ã“ã¡ã‚‰ã®è¨˜äº‹](https://medium.com/@foyemc/implementation-of-service-worker-using-reactjs-application-to-build-pwa-6366fd9a0527)ã‚’å‚è€ƒã«ã—ã¦å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

:::details sw.js
```js
// sw.js -> ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã®æœ¬ä½“
// injected by vite during build
const currentVersion = '<commit-hash>';

self.addEventListener('install', (e) => {
  console.log('Service worker install', e);
  self.skipWaiting();
});

self.addEventListener('activate', async (e) => {
  // Take control of the page as soon as the service worker is activated.
  self.clients.claim().then(() => {
    self.clients.matchAll().then((clients) => {
      for (const client of clients) {
        client.postMessage('service worker activated');
      }
    });
  });
});

self.addEventListener('message', (e) => {
  // NOTE: main threadã‹ã‚‰é€šçŸ¥ãŒå—ã‘å–ã‚‹ã¨ã€å…¨ã¦é–‹ã„ã¦ã„ã‚‹ã‚¿ãƒ–ã«`UPDATE_AVAILABLE`ã‚’é€ä¿¡ã—ã€
  // æ›´æ–°ãŒã‚ã‚‹ã¨ã®çŠ¶æ…‹ã¯ã‚ã‹ã‚‹ã‚ˆã†ã«ãªã‚‹
  if (e.data && e.data.action === 'notifyUpdate') {
    console.log('remove cache');
    e.waitUntil(
      caches
        .keys()
        .then((cacheNames) => {
          return Promise.all(
            cacheNames.map((cache) => {
              // if (!cacheWhitelist.includes(cache)) {
              return caches.delete(cache);
              // }
            }),
          );
        })
        .then(() => {
          console.log('notify main thread for update');
          self.clients.matchAll().then((clients) => {
            for (const client of clients) {
              // Post a message to each client to reload the page
              client.postMessage({ type: 'UPDATE_AVAILABLE' });
            }
          });
        }),
    );
  }
});
```
:::

ã•ã‚‰ã«ã€é€šä¿¡ã™ã‚‹å´ã®ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã™ã‚‹ã®ã¨ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã®ãŒå¿…è¦ã§ã™ã€‚

:::details registerServiceWorker
```ts
const registerServiceWorker = () => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker
      .register('/sw.js', { scope: './' })
      .then(function (registration) {
        console.log('Service worker registered', registration);
        // NOTE: updatefoundã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦ã€ç™ºç«æ™‚ã«ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã«é€šçŸ¥ã‚’å‡ºã™
        registration.addEventListener('updatefound', () => {
          const newServiceWorker = registration.installing;
          if (newServiceWorker != null) {
            newServiceWorker.addEventListener('statechange', () => {
              if (newServiceWorker.state === 'activated') {
                console.log('update available');
                newServiceWorker.postMessage({ action: 'notifyUpdate' });
              }
            });
          }
        });
      })
      .catch(function (error) {
        console.log('Failed to register service worker', error);
      });
  }
};
```
:::

ä¸Šè¨˜ã®é–¢æ•°ã‚’ã€Reactã®ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹éš›ã«å®Ÿè¡Œã—ã¾ã™ã€‚

:::details root
```tsx
const rootElement = document.getElementById('root')!;
if (rootElement.innerHTML === '') {
  ReactDOM.createRoot(rootElement).render(
    <React.StrictMode>
      <AppRoot />
    </React.StrictMode>,
  );
  registerServiceWorker();
}
```
:::

ã‚ã¨ã¯ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æƒ…å ±ã‚’æ¸¡ã™ãŸã‚ã«ã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œã‚Šã¾ã™ã€‚

:::details ContextProvider
```tsx
function AppUpdateProvider({ children }) {
  const [hasNewAppVersion, setHasNewAppVersion] = useState(false);

  useEffect(() => {
    if ('serviceWorker' in navigator) {
      const handleMessage = (e: MessageEvent) => {
        if (e.data?.type === 'UPDATE_AVAILABLE') {
          console.log('Update available!');
          setHasNewAppVersion(true);
        }
      };

      navigator.serviceWorker.addEventListener('message', handleMessage);

      // Cleanup listener on unmount
      return () => {
        navigator.serviceWorker.removeEventListener('message', handleMessage);
      };
    }
  }, []);

  return (
    <AppUpdateContext.Provider value={{ hasNewAppVersion }}>
      {children}
    </AppUpdateContext.Provider>
  );
}
```
:::


ã“ã‚Œã§ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ã©ã†ã‹ã®æƒ…å ±ã¯ã€ã‚¢ãƒ—ãƒªå´ã§çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ãã®ã‚ã¨ã¯ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãªã‚Šã€è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ãªã‚ŠãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### SWæ¡ˆã®å•é¡Œç‚¹

ã“ã‚Œã§ã¾ã§è¦‹ã‚‹ã¨ã€**æ›´æ–°æ¤œçŸ¥**ãŒå¯èƒ½ã«ãªã£ãŸã‚ˆã†ã«è¦‹ãˆã¦ã—ã¾ã„ã¾ã™ãŒã€å®Ÿã¯ã‹ãªã‚Šè‡´å‘½çš„ãªå•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

- æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¤œçŸ¥ã™ã‚‹ã€`updatefound`ã‚¤ãƒ™ãƒ³ãƒˆè‡ªä½“ã¯é »ç¹ã«èµ·ã“ã‚‰ãªã„
  - å®šæœŸæ›´æ–°æ¤œçŸ¥ã¯ã€24æ™‚é–“ç½®ãã«ãªã‚‹ -> é•·ã™ãã¦è§£æ±ºã«ãªã‚‰ãªã„
  - ã‚‚ã—ãã¯ç”»é¢ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«æ›´æ–°ãƒã‚§ãƒƒã‚¯ãŒè¡Œã‚ã‚Œã‚‹ -> é³¥ãŒå…ˆã‹åµãŒå…ˆã‹ã®å•é¡Œã«ãªã‚‹
- è‡ªå‹•æ›´æ–°æ¤œçŸ¥ã‚’è«¦ã‚ã€æ‰‹å‹•ã§æ›´æ–°æ¤œçŸ¥ã™ã‚‹ï¼ˆ[update](https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/update)ã§ãƒãƒ¼ãƒªãƒ³ã‚°ï¼‰ã¨ã€ä¸€å®šã®é »åº¦ã‚’è¶…ãˆã‚‹ã¨`Service workder self-update limit exceeded`ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã‚‹


ã¾ãŸã€ã‚‚ã†ä¸€ã¤æ½œåœ¨çš„ãªè¤‡é›‘åº¦ã‚’ä¸Šã’ã‚‹å•é¡Œã¨ã—ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã§ãã‚‹ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã¯åˆ¥ç³»çµ±ã‹ã¤ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã‚³ãƒ¼ãƒ‰ã§åˆ¶å¾¡ã§ããªã„ãŸã‚ã€ã†ã¾ãã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã™ã‚‹ãŸã‚ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã®HTTPã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹ã«ã—ã¦ã€**å…¨éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼å´ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†ã™ã‚‹**ã“ã¨ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡é–¢é€£ã®å®Ÿé¨“ã‚’å§‹ã‚ã‚‹å‰ã«ã€ã™ã§ã«ã“ã®æ–¹é‡ã®é™ç•Œã‚’æ„Ÿã˜ã¦ã—ã¾ã„ã€èˆµã‚’åˆ‡ã‚‹ã‚ˆã†ã«æ±ºã‚ã¾ã—ãŸã€‚

## è§£æ±ºãƒˆãƒ©ã‚¤ï¼’ãƒ¼ãƒãƒ¼ãƒªãƒ³ã‚°ã¨ãƒ«ãƒ¼ãƒˆé·ç§»ç›£è¦–

ä¸Šè¨˜ã®æ¡ˆã§ã¯èº“ã„ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€è‰¯ã„ãƒ’ãƒ³ãƒˆãŒå®Ÿã¯ã‚ã‚Šã¾ã—ãŸã€‚è¦ã¯ã€**æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¤œçŸ¥ã¯ã€ã‚ˆã‚ŠçŸ­ã„é »åº¦ã§ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ã®ã§ã‚ã‚Œã°ã€ã‚¢ãƒ—ãƒªå´ã§ã‚‚ã§ãã‚‹**ã¨ã®ã“ã¨ã§ã™ã€‚

### ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

SWæ¡ˆã§ã¯ã€`sw.js`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã™ã‚‹ã“ã¨ã§ã€æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¯ã€`version.json`ã¨ã‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ç½®ã„ã¦ãŠã‘ã°ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‹ã‚‰ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚§ãƒƒãƒã™ã‚Œã°ã‚ˆã„ã®ã§ã™ã€‚

:::details version.json
```json
{"commitHash": "54f83fdfc8bb9935bd268b7ef3f869ce9d931a5d"}
```
:::

VITEã§ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ä¾‹ã¨ã—ã¦ã€

:::details vite.config.ts
```ts
import react from '@vitejs/plugin-react-swc';
import { execFileSync } from 'node:child_process';
import { mkdirSync, writeFileSync } from 'node:fs';
import path from 'node:path';
import { defineConfig, loadEnv, type PluginOption } from 'vite';

// https://vitejs.dev/config/
export default defineConfig(({ mode }) => {
  // ...
  const commitHash = execFileSync('git', ['rev-parse', 'HEAD']).toString().trim();
  const versionInfo: PluginOption = {
    name: 'version-info',
    apply: 'build',
    generateBundle() {
      const distDir = path.resolve(__dirname, 'dist');
      const filePath = path.join(distDir, 'version.json');
      // å®Ÿè¡Œé †ç•ªæ¬¡ç¬¬ã§distãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ãŒä½œã‚‰ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹
      mkdirSync(distDir, { recursive: true });
      writeFileSync(filePath, JSON.stringify({ commitHash }));
    },
  };

  return {
    define: {
        // FEå´ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚‹
      __VERSION_COMMIT_HASH__: JSON.stringify(commitHash),
    },
    plugins: [versionInfo, react()],
    // ...
  };
});
```
:::

ã“ã‚Œã§éƒ½åº¦`version.json`ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ“ãƒ«ãƒ‰å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã«ãŠã‹ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚¢ãƒ—ãƒªå´ã®ã‚³ãƒ¼ãƒ‰ã«ã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®å®šæ•°ã¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æƒ…å ±ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

æ¬¡ã¯ã‚¢ãƒ—ãƒªå´ã§ãã®å†…å®¹ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚Œã°è‰¯ã„ã®ã§ã™ã€‚

:::details useAppVersion.ts
```ts
const useAppVersion = () => {
  const { isSuccess, data } = useQuery<{ commitHash: string }>({
    queryKey: ['appVersion'],
    queryFn: () => fetch('/version.json').then((r) => r.json()),
    refetchInterval: 60 * 1000,
    // ...
  });
  return isSuccess ? data.commitHash : null;
};
```
:::

### ãƒ«ãƒ¼ãƒˆé·ç§»ç›£è¦–

ã“ã‚Œã¾ã§æ›´æ–°æ¤œçŸ¥ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã®å½¢ã§å¯èƒ½ã«ã—ã¾ã—ãŸã€‚æ›´æ–°ãŒã‚ã‹ã£ãŸã‚ã¨ã®å‹•ãã¨ã—ã¦ã€ä»Šå›ã®æˆ¦ç•¥ã¯ã€é€šçŸ¥ãƒˆãƒ¼ã‚¹ãƒˆã¾ãŸã¯é»™ã€…ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ã¯ãªãã€ãƒ—ãƒ©ãƒ³Cã«ã—ã¾ã—ãŸã€‚ã“ã®ã‚¨ãƒ©ãƒ¼è‡ªä½“ã¯ã€æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚Šã€ãƒ«ãƒ¼ãƒˆé·ç§»ã™ã‚‹éš›ã«èµ·ã“ã‚‹ãŸã‚ã€**ãƒ«ãƒ¼ãƒˆé·ç§»ã‚’æ¤œçŸ¥ã§ãã‚Œã°ã€è‡ªå‹•ã§ç”»é¢ãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã†**ã“ã¨ã§ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¯ãšã§ã™ã€‚

å®Ÿè£…æ–¹æ³•ã¯FEå´ã§åˆ©ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼ã«ã‚ˆã‚Šã¾ã™ãŒã€è€ƒãˆæ–¹ã¯åŒã˜ã¯ãšãªã®ã§ã€ã“ã“ã¯[reactrouterã®ä¾‹](https://reactrouter.com/en/main/start/concepts#history-object)ã‚’å‡ºã—ã¾ã™


:::details AppVersionWrapper
```ts
// import { useLocation } from 'react-router-dom'; -> ã‚‚ä¸€å¿œãƒ«ãƒ¼ãƒˆç›£è¦–å¯èƒ½
function AppVersionWrapper({ children, history }) {
  const remoteVersion = useAppVersion();
  const localVersion = __VERSION_COMMIT_HASH__;
  const hasNewAppVersion = useMemo(() => {
    return (
      remoteVersion != null &&
      remoteVersion !== localVersion
    );
  }, [remoteVersion, localVersion]);

  const registered = useRef(false);
  useEffect(() => {
    if (!hasNewAppVersion) return;
    if (registered.current) return;
    registered.current = true;
    const unlisten = history.listen(() => {
      console.log('new app version detected, reloading...');
      window.location.href = history.location.href;
    });
    return () => {
      unlisten();
      registered.current = false;
    };
  }, [hasNewAppVersion, router]);

  return <>{children}</>;
}
```
:::

### ã¾ã¨ã‚

ã“ã®ãƒˆãƒ©ã‚¤ã§ã§ããŸã“ã¨ã¨ã—ã¦

- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ï¼ˆã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ï¼‰ã‚’ã‚¢ãƒ—ãƒªå´ã¨ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã«ä¸¡æ–¹ä¿æŒã•ã›ã‚‹
- ã‚¢ãƒ—ãƒªå´ã§ã¯ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã«å¯¾ã—ã¦ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã€æ›´æ–°æ¤œçŸ¥ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹
- æ›´æ–°æ¤œçŸ¥ãŒã§ãã‚‹ã¨ã€ãã®æƒ…å ±ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚¹ãƒ†ãƒ¼ãƒˆã¨ã—ã¦ä¿æŒã™ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ«ãƒ¼ãƒˆé·ç§»ã‚’ç›£è¦–ã—ã€æ›´æ–°ãŒã‚ã‚‹éš›ã«ç”»é¢ãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã†

## è§£æ±ºãƒˆãƒ©ã‚¤3ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæˆ¦ç•¥èª¿æ•´

ä¸Šè¨˜ã®ãƒˆãƒ©ã‚¤ã§ã¯ã€ã‚¢ãƒ—ãƒªæ›´æ–°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒãƒ¼ãƒªãƒ³ã‚°ã¨æ›´æ–°æ¤œçŸ¥è§£æ±ºã«ãªã£ã¦ã„ã¾ã™ãŒã€ã¾ã ä¸€ã¤å¤§ããªå•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€**ç”»é¢ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ã€ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆãªã„å¯èƒ½æ€§ãŒã‚ã‚‹**ã¨ã“ã‚ã§ã™ã€‚

ã“ã‚Œã¯åŸå› åˆ†æã®ã¨ã“ã‚ã§è§¦ã‚Œã¾ã—ãŸãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã£ã¦å•é¡Œã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã—ã¾ã„ã€TTLãŒåˆ‡ã‚Œã‚‹ã¾ã§ã‚¨ãƒ©ãƒ¼ãŒæ¶ˆãˆãªã„ã®ã§ã™ã€‚`Failed to fetch dynamically imported module`ã®ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã¨ã€MIME`ã‚¿ã‚¤ãƒ—ã®ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã„ã‚‹ã®ã§ã™ã€‚ãƒˆãƒ©ã‚¤2ã®ãƒ«ãƒ¼ãƒˆé·ç§»ç›£è¦–ã¯ã€å³å¯†ã«è¨€ãˆã°ã€`beforeRouteChanged`ã§ã¯ãªãã€`afterRouteChanged`ã«ãªã‚‹ã®ã§ã€å­˜åœ¨ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå…ˆã«é£›ã°ã•ã‚Œã‚‹ã¨ã€ã“ã®å•é¡Œã«ç¹‹ãŒã‚Šã¾ã™ã€‚

```
Failed to load module script: Expected a JavaScript module script but the server responded with a MIME type of "text/html". Stict MIME type checking is enforced for module scripts per HTML spec.
```


ãã®ãŸã‚ã€ã“ã“ã®è€ƒãˆã¨ã—ã¦ã¯ã€

- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸããªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†ã™ã‚‹**
- ãªã‚“ã§ã‚‚`index.html`ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ»ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã®ã§ã¯ãªãã€**`index.html`ã§è¿”ã£ã¦è‰¯ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã€ãã†ã—ãŸããªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ•´ç†ã™ã‚‹**
 - **`index.html`ã«ã—ãŸããªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã®ä»£æ¡ˆã‚’æ±ºã‚ã‚‹**

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯firebase hostingã«ãƒ›ã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä»¥ä¸‹ã¯firebase hostingç”¨ã®è¨­å®šã§ä¾‹ã«ã—ã¾ã™ã€‚

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡æ•´ç†

èª¿æ•´å¾Œã®`headers`ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™ã€‚

:::details firebase.json
```json
{
  "hosting": {
    "headers": [
      {
        "source": "/**",
        "headers": [
          { "key": "Cache-Control", "value": "no-cache,no-store" },
        ]
      },
      {
        "source": "**/*.@(jpg|jpeg|gif|ico|png|svg|webp|js|css|eot|otf|ttf|ttc|woff|woff2|font.css)",
        "headers": [
          { "key": "Cache-Control", "value": "max-age=31536000,immutable" },
        ]
      }
    ]
  }
}
```
:::

ã“ã“ã®ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦
- `js`, `css`ã‚„ç”»åƒã€ãƒ•ã‚©ãƒ³ãƒˆãªã©ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„
  - ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã®ãƒ•ã‚¡ã‚¤ãƒ«åãƒãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‹ãƒ³ã‚°ã‚ã‚‹ã®ã§ã€`immutable`ã§è‰¯ã•ãã†ï¼ˆ[ å‚è€ƒ ](https://simonhearne.com/2022/caching-header-best-practices/#the-solution)
  - ãŸã ã€`immutable`ãŒãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ã«ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ï¼ˆ[å‚è€ƒ](https://caniuse.com/mdn-http_headers_cache-control_immutable)ï¼‰ã€é«˜ã„`max-age`(ä¸Šè¨˜ã§ã¯1å¹´)ã§ç„¡é›£
- ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã„ã†ã¨ã€`index.html`ã¨`version.json`ã«å½“ãŸã‚‹
  - ã“ã®äºŒã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦æ¬²ã—ããªã„ã®ã§ã€`no-cache`ã‹çµæ§‹ä½ã„`max-age`ã§è‰¯ã„ï¼ˆ[ å‚è€ƒ ](https://stackoverflow.com/questions/48589821/firebase-hosting-how-to-prevent-caching-for-the-index-html-of-an-spa)ï¼‰
  - ãŸã ã€ä½ã„`max-age`ã ã¨ã€ã‚„ã¯ã‚Šãã®åˆ†ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚é–“ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€å¾¹åº•çš„ã«è§£æ±ºã™ã‚‹ã«ã¯åŸºæœ¬`no-cache`ã«ã—ãŸã„

ãªãŠã€firebase hostingã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§CDNã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™ãŒã€æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã‚ã‚‹ã¨ã€CDNä¸Šã®ã‚­ãƒ¥ã‚¢ãƒƒã‚·ãƒ¥ã¯[ãƒ‘ãƒ¼ã‚¸ã•ã‚Œã‚‹](https://zenn.dev/teramotodaiki/articles/676468e8e40763)ã®ã§ã€ãã“ã®åˆ¶å¾¡ã¯ç‰¹ã«è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“ã€‚

### `index.html`ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

`index.html`ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã¨ãªã‚Šã¾ã™([rewritesã«ã¤ã„ã¦ã®å‚è€ƒ](https://firebase.google.com/docs/hosting/full-config#rewrites))ã€‚

:::details firebase.json
```json
{
  "hosting": {
    "rewrites": [
      {
        "source": "/",
        "destination": "/index.html"
      },
      {
        "source": "/user{,/**}",
        "destination": "/index.html"
      },
      {
        "source": "/admin{,/**}",
        "destination": "/index.html"
      }
    ]
  }
}
```

ã“ã“ã®ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€
- ã‚¢ãƒ—ãƒªå´å­˜åœ¨ã™ã‚‹URLã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ç”»é¢ãƒ»ãƒšãƒ¼ã‚¸ã®ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã ã‘ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾è±¡ã¨ã™ã‚‹
  - `/`, `/user`ã‹ã‚‰å§‹ã¾ã‚‹URLã€`/admin`ã‹ã‚‰å§‹ã¾ã‚‹URLã€ã¨ã„ã†3ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ã€`index.html`ãŒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ãªã‚‹
  - ä¸Šè¨˜ä»¥å¤–ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€**404ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹**
- js, cssãªã©ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„
  - é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹URIã¨ã—ã¦ã€`/abc.js`, `/def.css`ã«ãªã£ã¦ã„ã‚‹
  - ç”»é¢é·ç§»å…ˆã«ã¯é€šå¸¸`js`ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€`/abc.js`ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹æ™‚ã«ã¯`index.html`ãŒè¿”ã‚‰ãšã€**404ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹**



### 404ã®å ´åˆãƒ¼ç”»é¢

ã•ã¦ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãŸããªã„å ´åˆã¯æ•´ç†ã§ããŸã¨ã“ã‚ã§ã€çµå±€404ã¯ã©ã†ã™ã‚‹ã®ã€ã¨ã®å•é¡ŒãŒæ®‹ã‚Šã¾ã™ã€‚

ã“ã“ã§ã¾ãšã¯ã€å­˜åœ¨ã—ãªã„URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ™‚ã®404ã«ã¤ã„ã¦å¯¾ç­–ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

ä»–ã®ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ã‚‚å…±é€šã™ã‚‹ã¨æ€ã„ã¾ã™ãŒã€404ã®å ´åˆã¯ã€ã‚‚ã—`404.html`ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæä¾›ã•ã‚Œã¦ã„ãªã‹ã£ãŸã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯firebaseã®404ç”»é¢ãŒè¦‹ãˆã¦ã—ã¾ã„ã¾ã™ã€‚

rewritesã§ã€`404.html` -> `index.html`ã¨ã®ç™ºæƒ³ã‚‚ä¸€å¿œã‚ã‚Šã¾ã—ãŸã€‚ã¤ã¾ã‚Šã€404ã®ãƒšãƒ¼ã‚¸ã‚’ã‚ãˆã¦è¨­ã‘ãšã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’ä»£ã‚ã‚Šã«ã™ã‚‹ä½œæˆ¦ã§ã™ã€‚ãŸã ã€ãƒ«ãƒ¼ã‚¿ãƒ¼ã«ã¨ã£ã¦ã€404ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹URLãŒã€ã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚‚ãƒãƒƒãƒã—ãªã„ã®ã§ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚ãªãã€ç”»é¢ãŒçœŸã£ç™½ã®ã¾ã¾ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

çµå±€ä¸€ç•ªç´ æœ´ãªæ–¹æ³•ã«ã—ã¦ã€404.htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ã¤ä½œã‚Šã¾ã—ãŸã€‚

ãªãŠã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ­£ã—ããƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã‚ã«ã€`vite`ã®è¨­å®šã‚‚å°‘ã—å¤‰æ›´ãŒå¿…è¦ã§ã™ã€‚

:::details vite.config.ts
```ts
export default defineConfig(({ mode }) => {
  // ...

  return {
    define: {
        // FEå´ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šæ•°ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚‹
      __VERSION_COMMIT_HASH__: JSON.stringify(commitHash),
    },
    plugins: [versionInfo, react()],
    build: {
      rollupOptions: {
        input: {
          main: path.resolve(__dirname, 'index.html'),
          404: path.resolve(__dirname, '404.html'),
        },
      },
    }
  };
});
```
:::

### 404ã®å ´åˆãƒ¼é™çš„ãƒ•ã‚¡ã‚¤ãƒ«

ä¸Šè¨˜ã§å­˜åœ¨ã—ãªã„ç”»é¢ã®404ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒè§£æ±ºã§ãã¾ã—ãŸãŒã€é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã™ã‚‹éš›ã«ã®404ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã€ã‚¨ãƒ©ãƒ¼æ•ç²ç”¨ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚

:::details AppErrorComponent.tsx
```tsx
const isModuleNotFoundError = (error: unknown): boolean => {
  return (
    error instanceof Error &&
    typeof error.message === 'string' &&
    error.message.includes('Failed to fetch dynamically imported module')
  );
};

function AppErrorComponent({ error }) {
  const isProd = import.meta.env.NODE_ENV === 'production';
  useEffect(() => {
    console.error('An error occurred', error);
    if (isModuleNotFoundError(error)) {
      console.log('reloading...');
      // prodç’°å¢ƒä»¥å¤–ã¯ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚ã«ç”»é¢ãƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„
      if (isProd) {
        window.location.reload();
      }
    }
  }, [error, isProd]);

  // ç‰¹ã«ãªã«ã‚‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãªã„
  return <CustomErrorComponent> {...} </CustomErrorComponent>;
}
```
:::

ã“ã“ã®ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã‚’æ•ç²ã—ãŸã¨ã“ã‚ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¨ãƒ©ãƒ¼ã®ç”»é¢ã‚’è¦‹ã›ãšã€ä½•ã‚‚ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒªãƒ³ã‚°ã—ãªã„ã¾ã¾ã€ãƒªãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã†ã¨ã“ã‚ã§ã™ã€‚

ãƒªãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã†ã“ã¨ã«ã‚ˆã£ã¦ã€`index.html`ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œãªã„ãŸã‚ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚¨ãƒ©ãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ãšã«æ¸ˆã‚€ã“ã¨ã§ã™ã€‚

### ã¾ã¨ã‚

ã“ã®ãƒˆãƒ©ã‚¤ã§ã§ããŸã“ã¨ã¨ã—ã¦ã€ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼å´ã®è¨­å®šèª¿æ•´ã—ã€
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸã„ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãŸããªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‰ã‚ŒãŸ
- `index.html`ã§è¿”ã£ã¦è‰¯ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã€ãã†ã—ãŸããªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ‡ã‚Šåˆ†ã‘ã‚‰ã‚ŒãŸ
- `index.html`ã«ã—ãŸããªã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã¯
  - å­˜åœ¨ã—ãªã„ç”»é¢ã«å¯¾ã—ã¦404.htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›ã™ã‚‹
  - å­˜åœ¨ã—ãªã„é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æä¾›ã™ã‚‹

ã“ã‚Œã‚‰ã®å¯¾ç­–ã«ã‚ˆã£ã¦ã€ã“ã®å•é¡Œã¯ã»ã¼è§£æ±ºã«è¿‘ã„ã¨ã‚‚è¨€ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## è§£æ±ºãƒˆãƒ©ã‚¤4ãƒ¼è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›

ã“ã‚Œã¾ã§å•é¡Œã¯è§£æ±ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ãŒã€ä¸‡ãŒä¸€ã‚’é˜²ããŸã‚ã«ã€å®Ÿã¯åˆ¥ã®å¯¾ç­–ã‚‚æ‰“ã£ã¦ã„ã¾ã—ãŸã€‚ã¨ã„ã†ã®ã¯ã€æ›´æ–°æ¤œçŸ¥ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã¯ã€1åˆ†é–“éš”ã§èµ·ãã‚‹ãŸã‚ã€ã©ã†ã—ã¦ã‚‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒæ‚ªãã€ãã®é–“éš”ä¸­ã«ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã£ã¦ã€æ¤œçŸ¥ã§ããšä¾‹ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šå¾—ã¾ã™ã€‚

ã“ã®å•é¡Œã®æ ¹æºã§è¨€ãˆã°ã€æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒªãƒªãƒ¼ã‚¹ã«ã‚ˆã£ã¦ã€**å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒãªããªã£ã¦ã„ã‚‹**ã¨ã“ã‚ã«ã‚ã‚‹ã®ã§ã€é€†ã«è€ƒãˆã‚‹ã¨ã€**å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ã«ã‚ˆã£ã¦å‰Šé™¤ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„**ã€ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€æ™‚ã«ãƒã‚°ä¿®æ­£ãªã©ã®é–¢ä¿‚ã§å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã—ãŸã„ã®ã§ã™ãŒã€ãã®ã‚±ãƒ¼ã‚¹ã‚‚å‚™ãˆã¦å¯¾å‡¦ã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚

ãŸã ã€firebase hostingã«ã¯ãã†ã„ã†æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€ã“ã“ã§è¤‡æ•°ã®ãƒªãƒªãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«æä¾›ã™ã‚‹æ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

### è¨­è¨ˆ

è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã¯ã€firebase hostingã¸ãƒ“ãƒ«ãƒ‰å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹éš›ã«ã€**ä»¥å‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã™ã‚Œã°è‰¯ã„ã“ã¨ã§ã™ã€‚

å•é¡Œã¨ã—ã¦ã€
- ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã©ã“ã§ã€ã©ã†ã„ã†æ§‹é€ ã§ä¿å­˜ã™ã‚‹ã‹
- ã©ã“ã¾ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å«ã‚ã‚‹ã‹ã€ãƒªãƒªãƒ¼ã‚¹ãŒç©ã¿é‡ãªã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤šããªã£ãŸæ™‚ã«ã©ã†ã™ã‚Œã°è‰¯ã„ã‹

ä¸€ã¤ç›®ã®å•é¡Œã«ã¤ã„ã¦ã€ãƒªãƒªãƒ¼ã‚¹æ¯ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹å ´æ‰€ãŒå¿…è¦ã§ã€ä»Šå›ã¯GCSã®ãƒã‚±ãƒƒãƒˆã«ã—ã¾ã—ãŸã€‚

- ç’°å¢ƒæ¯ã«ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚Šã€liveã¨activeã®2ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’è¨­ã‘ã‚‹
- liveãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã¯ã€firebase hostingã¨åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹
  - ã“ã“ã§è¤‡æ•°ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã¨æƒ³å®š
- activeãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã¯ã€ä»Šã¾ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç‹¬ç«‹ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ä¿å­˜ã™ã‚‹
  - ä¿å­˜å…ˆã¯`active/<YYYY-MM-DD>/<timestamp>-<commit-hash>/<file-path>.<ext>`ã®å½¢ã«å›ºã‚ã‚‹
  - ã‚½ãƒ¼ãƒˆã—ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€æ—¥ä»˜ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å…ˆé ­ã«ã¤ã‘ã‚‹

äºŒã¤ç›®ã®å•é¡Œã«ã¤ã„ã¦å¤šå°‘è¤‡é›‘ã«ãªã‚Šã¾ã™ãŒã€ä¸‹è¨˜ã®3ã¤ã®APIã§å¯¾å‡¦ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

- `upload`: ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆã«åŸºã¥ã„ã¦ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆactiveãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
- `merge`: å¼•æ•°ã§æ±ºã‚ã‚‰ã‚ŒãŸè¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ä¸€ã¤ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ãƒãƒ¼ã‚¸ã—ã€liveãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä¸Šæ›¸ãã™ã‚‹
- `purge`: å¼•æ•°ã§æ±ºã‚ã‚‰ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚±ãƒƒãƒˆactiveãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‹ã‚‰å‰Šé™¤ã™ã‚‹

ãƒªãƒªãƒ¼ã‚¹è‡ªä½“ã¯å…¨éƒ¨CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ãªã‚Šã¾ã™ãŒã€æƒ³å®šã™ã‚‹ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦ã€
- `npm run build`ã§ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã§ã€`dist`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
- `upload`ã§ä¸Šè¨˜ã®`dist`ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã—ã¦`active`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
- `merge`ã§æ±ºã‚ã‚‰ã‚ŒãŸ`active`å†…ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€å®Ÿè¡Œç’°å¢ƒã§`dist`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ãƒãƒ¼ã‚¸ã•ã›ã€`live`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ä¸Šæ›¸ãã™ã‚‹
- ä¸Šè¨˜ã®`dist`ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’ç”¨ã„ã¦ã€firebase hostingã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- å¾Œå‡¦ç†ã¨ã—ã¦ã€ä¸€å®šæœŸé–“ã‚ˆã‚Šå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’`purge`ã§å‰Šé™¤ã™ã‚‹
  - `purge`ã¯å®šæœŸå®Ÿè¡Œã‚„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã§è‡ªå‹•å‰Šé™¤ã‚‚æ¤œè¨ã—ã¾ã—ãŸãŒã€çµå±€ãƒªãƒªãƒ¼ã‚¹ã®é »åº¦ã¯åŸºæœ¬äºŒé€±é–“1-2å›ç¨‹åº¦ã§ã€ãƒªãƒªãƒ¼ã‚¹ã®å¾Œã§å®Ÿè¡Œã™ã‚Œã°ååˆ†ã¨æ±ºã‚ã¾ã—ãŸã€‚


### å®Ÿè£…

ã“ã‚Œã‚‰ã®APIã‚’ã©ã“ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã®ã‹ã€ã¨ã®è­°è«–ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€`oclif`ã‚’åˆ©ç”¨ã—ã¦CLIã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆã—ã¦ã„ãŸãŸã‚ã€ãã®ã¾ã¾è¸è¥²ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œä¸­ã¯ã€ã“ã‚‰ã‚‰ã®CLIã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§ç›®çš„ã¯é”æˆã§ãã¾ã™ã€‚

ç´°ã‹ã„å®Ÿè£…ã‚’çœã„ã¦ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ä¸€éƒ¨è¦æ³¨æ„ãªéƒ¨åˆ†ã®ã¿æç¤ºã—ã¾ã™ã€‚

#### `base`

ã‚³ãƒãƒ³ãƒ‰å…±é€šã®éƒ¨åˆ†ã‚’å®šç¾©ã—ã¾ã™ã€‚ã“ã‚Œã¯ã‚ãã¾ã§ã‚‚ç¶™æ‰¿ç›®çš„ã§ã‚ã£ã¦ã€ç›´æ¥ã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ä½¿ã„ã¾ã›ã‚“ã€‚

:::details base
```ts
import type { Bucket, File } from '@google-cloud/storage';
import { Storage } from '@google-cloud/storage';
import { Command, Flags } from '@oclif/core';

export default abstract class Base extends Command {
  static description =
    'multi-release base command, this is only an abstract class for inheritance purpose';

  static hidden = true;
  static flags = {
    bucket: Flags.string({
      description: 'bucket name',
    }),
    env: Flags.enum({
      description: 'environment name',
      options: ['prd', 'stg', 'dev'],
      required: true,
    }),
  };

  abstract commandName: string;

  run(): Promise<void> {
    throw new Error('Invalid operation, command is not executable!');
  }

  getBucketName(env: Env): string;

  getProjectId(env: Env): string;

  getLocalDistDir(): string;

  findReleases(files: readonly string[]): string[];

  async listAllFiles(client: Bucket) {
    const files: string[] = [];
    return await new Promise<string[]>((resolve, reject) => {
      // NOTE: ã“ã“ã¯è¦æ³¨æ„ã€å®Ÿè£…å½“æ™‚ã§ã¯ã€ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã®ã¿å–å¾—ã™ã‚‹ã®ã¯ã§ããªã‹ã£ãŸ
      // {autoPaginate:false, dilimiter: '/'}ã§ã‚‚æ­£ã—ã„ãƒ‘ã‚¹ã¯å–ã‚Œãªã„
      client
        .getFilesStream({ prefix: 'active/' })
        .on('error', reject)
        .on('data', (file: File) => {
          files.push(file.name);
        })
        .on('end', () => {
          resolve(files);
        });
    });
  }

  async uploadFilesInDir(client: Bucket, localDir: string, destDir: string): Promise<number>;

  async getStorageClient(projectId: string, bucket: string): Promise<Bucket>;
}
```
:::

#### `upload`

åŸºæœ¬ç¶™æ‰¿ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ãˆã°å®Œæˆã€‚

:::details upload
```ts
import { Flags } from '@oclif/core';
import Base from './base';

export default class Upload extends Base {
  static description =
    'multi-release upload command, upload current build files to remote storage bucket';

  static examples = [
    `$ app-cli multi-release upload --bucket=...  --partition=... --commit=...`,
  ];

  static flags = {
    ...Base.flags,
    commit: Flags.string({
      description: 'commit hash of current release',
      required: true,
    }),
  };

  commandName = 'upload';

  async run(): Promise<void> {
    const {
      flags: { bucket, env, commit },
    } = await this.parse(Upload);

    const bucketName = bucket ?? this.getBucketName(env);
    const projectId = this.getProjectId(env);
    const client = await this.getStorageClient(projectId, bucketName);
    const destDir = this.getUploadDestDir(commit);
    try {
      const localDistDir = this.getLocalDistDir();
      const count = await this.uploadFilesInDir(client, localDistDir, destDir);
      // ... log
    } catch (error: unknown) {
      // å¤±æ•—æ™‚ã«è©²å½“ãƒªãƒªãƒ¼ã‚¹ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹
      await client.deleteFiles({ prefix: destDir });
      throw error;
    }
  }

  // Format: active/<YYYY-MM-DD>/<timestamp>-<commit>/
  getUploadDestDir(commit: string): string;
}
```
:::

#### `merge`

ãƒªãƒªãƒ¼ã‚¹ã‚’ã©ã®ã‚ˆã†ã«è¦‹ã¤ã‘ã‚‹ã‹ã€æ–¹é‡ã¯2ã¤æ±ºã‚ã¾ã—ãŸã€‚æ—¥æ•°ï¼ˆä¾‹ãˆã°7æ—¥ä»¥å†…ï¼‰ã¨å›æ•°ï¼ˆä¾‹ãˆã°ç›´è¿‘ï¼“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ãŒä¸¡æ–¹å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ãŒã€åŒæ™‚ã«ã‚ã‚‹å ´åˆã¯ã€ã‚ˆã‚Šãƒªãƒªãƒ¼ã‚¹ä»¶æ•°ã®å¤šã„æ–¹ãŒå„ªå…ˆã•ã‚Œã¾ã™ã€‚

:::details merge
```ts
import { type Bucket } from '@google-cloud/storage';
import { Flags } from '@oclif/core';
import Base from './base';

export default class Merge extends Base {
  static description =
    'multi-release merge command, fetch multiple build version files and merge them into a single build, upload to remote storage bucket';

  static examples = [
    `$ app-cli multi-release merge --bucket=... --days=... --partition=... --latest=2`,
  ];

  static flags = {
    ...Base.flags,
    days: Flags.integer({
      description:
        'keep releases in last n days, the larger value will be prioritized if conflicted with `latest`',
      min: 1,
      max: 10_000,
    }),
    latest: Flags.integer({
      description:
        'keep releases in last n versions including current release, the larger value will be prioritized if conflicted with `days`',
      min: 1,
      max: 10_000,
    }),
  };

  commandName = 'merge';

  async run(): Promise<void> {
    const {
      flags: { bucket, env, days, latest },
    } = await this.parse(Merge);

    const bucketName = bucket ?? this.getBucketName(env);
    const projectId = this.getProjectId(env);
    const client = await this.getStorageClient(projectId, bucketName);
    try {
      const localDistDir = this.getLocalDistDir();
      const filenames = await this.listAllFiles(client);
      const releases = this.getMergeTargetReleases({ filenames, latest, days });
      const fileEntries = this.getReleasesFileEntries({ filenames, releases });
      await this.downloadRemoteFiles({
        client,
        fileEntries,
        downloadTo: localDistDir,
      });
      // ãƒãƒ¼ã‚¸ã•ã‚ŒãŸdistã‚’gcsä¸Šã® `live` ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      await client.deleteFiles({ prefix: 'live/' });
      const count = await this.uploadFilesInDir(client, localDistDir, 'live/');
      // ... log
    } catch (error: unknown) {
      // ...
      throw error;
    }
  }

  async downloadRemoteFiles({
    client,
    fileEntries,
    downloadTo,
  }: Readonly<{
    client: Bucket;
    fileEntries: Array<[string, string]>;
    downloadTo: string;
  }>) : Promise<void>;

  getMergeTargetReleases({
    filenames,
    latest,
    days,
  }: Readonly<{
    filenames: readonly string[];
    latest?: number;
    days?: number;
  }>) : string[];

  /*
   * ç›´è¿‘ã®ãƒªãƒªãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’è¦‹ã¤ã‘å‡ºã—ã€
   * ãƒ•ã‚¡ã‚¤ãƒ«åã¨ãƒã‚±ãƒƒãƒˆä¸Šã®ãƒ‘ã‚¹ã‚’å–å¾—ã™ã‚‹ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã«ç«¶åˆãŒã‚ã‚‹
   * å ´åˆã¯ã‚ˆã‚Šæ–°ã—ããƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã¨ãªã‚‹ã€‚
   *
   * @returns Array<[fileName, fileFullPath]>
   */
  getReleasesFileEntries({
    filenames,
    releases,
  }: {
    filenames: readonly string[];
    releases: readonly string[];
  }): Array<[string, string]>;

  filterReleasesByDay(releases: readonly string[], days: number): string[];
}
```
:::

#### `purge`

å‰Šé™¤ã‚‚æ—¥æ•°ã¨å›æ•°ä¸¡æ–¹å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šåºƒã„ç¯„å›²ã®æ–¹ãŒå„ªå…ˆã•ã‚Œã¦ã€ã‚­ãƒ¼ãƒ—å¯¾è±¡ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰ã«ãªã‚Šã¾ã™ã€‚

:::details purge
```ts
import { Flags } from '@oclif/core';
import Base from './base';

export default class Purge extends Base {
  static description =
    'multi-release purge command, fetch multiple build version files and purge them into a single build, upload to remote storage bucket';

  static examples = [
    `$ app-cli multi-release purge --bucket=... --days=... --partition=... --latest=2`,
  ];

  static flags = {
    ...Base.flags,
    keepDays: Flags.integer({
      description:
        'delete releases except ones in last n days, the larger value will be prioritized if conflicted with `keepLatest` and lesser releases will be deleted',
      min: 1,
      max: 10_000,
    }),
    keepLatest: Flags.integer({
      description:
        'delete releases except ones n versions, the larger value will be prioritized if conflicted with `keepDays` and lesser releases will be deleted',
      // æœ€å°ã§ç›´è¿‘ã®ï¼’ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒ
      min: 2,
      max: 10_000,
    }),
  };

  commandName = 'purge';

  async run(): Promise<void> {
    const {
      flags: { bucket, env, keepDays, keepLatest },
    } = await this.parse(Purge);

    const bucketName = bucket ?? this.getBucketName(env);
    const projectId = this.getProjectId(env);
    const client = await this.getStorageClient(projectId, bucketName);
    if (keepDays == null && keepLatest == null) {
      throw new Error('Either `keepDays` or `keepLatest` are required');
    }
    try {
      const filenames = await this.listAllFiles(client);
      const releases = this.findReleases(filenames);
      const targetReleases = this.getDeleteTargetReleases({
        releases,
        keepDays,
        keepLatest,
      });

      await Promise.all(targetReleases.map(prefix => client.deleteFiles({ prefix })));
    } catch (error: unknown) {
      // ...
      throw error;
    }
  }

  getDeleteTargetReleases({
    releases,
    keepLatest,
    keepDays,
  }: Readonly<{
    releases: readonly string[];
    keepLatest?: number;
    keepDays?: number;
  }>): string[];

  filterDeleteTargetsByDay(releases: readonly string[], keepDays: number): string[];
}

```
:::

### ã¾ã¨ã‚

ã“ã®ãƒˆãƒ©ã‚¤ã§ã§ããŸã“ã¨ã¨ã—ã¦

- éå»ã®ãƒªãƒªãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒæ™‚ã«ãƒ›ã‚¹ãƒˆã™ã‚‹ã“ã¨
- è‡ªå‹•åŒ–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åˆ©ç”¨ã—ã€upload -> merge -> purgeã®æµã‚Œã§æ•´ç†ã§ããŸã“ã¨
- oclifã®CLIã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ã€æ‰‹å‹•å®Ÿè¡ŒãŒå¿…è¦ãªå ´é¢ã«ã‚‚å¯¾å¿œå¯èƒ½ã«ãªã‚‹ã“ã¨


## çµ‚ã‚ã‚Šã«

ä»Šå›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒªãƒªãƒ¼ã‚¹ã—ã¦ã‹ã‚‰ã¾ã‚‚ãªã1å¹´ã«ãªã‚Šã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã¯0->1ã®æ®µéšãŒçµ‚ã‚ã£ã¦ã„ã¾ã™ãŒã€ãƒªãƒªãƒ¼ã‚¹ã®ãŸã³ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã‚’å–ã‚‰ãªã„ã¨ã„ã‘ãªã„ã€ã¨ã®ä¿å®ˆé‹ç”¨ã®èª²é¡ŒãŒãšã£ã¨æ®‹ã£ã¦ã„ã¾ã—ãŸã€‚

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ–¹ã¯ã€æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã‚’CloudRun Jobsã«ä»»ã›ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€éåœæ­¢ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸãŒã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯`Failed to fetch dynamically imported module`ã®é–¢ä¿‚ã§æ»ã£ã¦ã„ã¾ã—ãŸã€‚

çµæ§‹æ™‚é–“ã‚’ã‹ã‘ã¦ã€èª¿æŸ»ã¨å®Ÿé¨“ã®ç¹°ã‚Šè¿”ã—ã‚’çµŒã¦ã€æ§˜ã€…ãªè¦–ç‚¹ã‹ã‚‰å¯¾ç­–ã‚’æ‰“ã¤ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ã“ã®å‰ç„¡äº‹ã«ãƒªãƒªãƒ¼ã‚¹ã§ãã€ãŠã‹ã’ã§ãã®å¾Œã¯æ—©æœæ·±å¤œã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ãªã—ã®ã€ãƒ˜ãƒ«ã‚·ãƒ¼ãªãƒ¡ãƒ³ã‚¿ãƒ«ã«æˆ»ã‚Šã¾ã—ãŸï¼ˆç¬‘ï¼‰ã€‚SPAã®ãƒªãƒªãƒ¼ã‚¹ã§ã€åŒã˜å•é¡Œã§æ‚©ã‚“ã§ã„ã‚‹æ–¹ã®å½¹ã«ç«‹ã¦ã‚‹ã¨å¬‰ã—ãæ€ã„ã¾ã™ã€‚

æœ€å¾Œã«ã€ä»Šå›ã®å•é¡Œã‚’ç«‹ã¡å‘ã‹ã†éš›ã«ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼@lumaã•ã‚“ã‹ã‚‰å¤šãã‚µãƒãƒ¼ãƒˆã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã„ãŸã ãã¾ã—ãŸã€‚ç‰¹ã«è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æä¾›ã™ã‚‹è¨­è¨ˆã«ãŠã„ã¦è²´é‡ãªã‚¢ã‚¤ãƒ‡ã‚£ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ãŠã‹ã’ã§ä»Šã®å½¢ã§æ²»ã£ã¦ã„ã¾ã™ã€‚ã“ã®å ´ã‚’å€Ÿã‚Šã¦æ„Ÿè¬ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚


