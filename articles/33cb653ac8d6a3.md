---
title: "Laravel æ¨©é™ç®¡ç†ã‚’å®Ÿè£…ã—ã¦ã¿ãŸè©±"
emoji: "ğŸ’­"
type: "tech"
topics:
  - "laravel"
  - "php"
  - "permission"
published: true
published_at: "2021-09-10 00:38"
---

ã¨ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã‚’ç”»é¢ã§ç®¡ç†ã—ãŸã„ã€ã¨ã®è¦æœ›ãŒã‚ã‚Šã¾ã—ãŸã€‚

è¦ã¯ä½•ã‹æ¨©é™ã®ä¸€è¦§ãŒã‚ã£ã¦ã€æ¨ªã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã‹å¤–ã™ã‹ã«ã‚ˆã£ã¦æ¨©é™ã‚’ç®¡ç†ã™ã‚‹ã¨ã€‚

ç”»é¢ã ã‘ãªã‚‰ç°¡å˜ã§ã™ãŒã€ãã‚Œã‚’å®Ÿéš›ã«ãƒ«ãƒ¼ãƒˆã®ä¿è­·ã€è¡¨ç¤ºå†…å®¹ã®ä¿è­·ã«ä½¿ã†ã®ã§ã‚ã‚Œã°ã€ã‚‚ã£ã¨æ·±å…¥ã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## äº‹å‰æº–å‚™

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€å½¹å‰²ã¨æ¨©é™ã®é–¢ä¿‚ã«ã¤ã„ã¦

å…¨ã¦è©±ã®ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãŸã‚ã€å…ˆã«æ˜ç¤ºã—ãŸæ–¹ãŒè‰¯ã„ã‹ã¨æ€ã„ã¾ã™ã€‚å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚ˆã£ã¦é•ã†ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯ä»¥ä¸‹ã®é–¢ä¿‚ã§å®Ÿè£…ã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/c269c18bfbc8045b56ba14eb.png)

ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ­ãƒ¼ãƒ«ãƒ»å½¹å‰²ã¯one-to-manyã®é–¢ä¿‚ã¨ãªã£ã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚Šã€ä¸€ã¤ã®å½¹å‰²ã«ã¯è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŒã¤ã€ä¸€äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä¸€ã¤ã®å½¹å‰²ã—ã‹æ‹…ã‚ãªã„ã€ã¨ã®æ§‹é€ ã§ã™ã€‚ã“ã‚Œã¯ã€ä»Šå›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹å½¹å‰²ãƒ»ãƒ­ãƒ¼ãƒ«è‡ªèº«ã®æ’ä»–æ€§ã«ã‚ˆã£ã¦one-to-manyã®é–¢ä¿‚æ€§ãŒæ±ºã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ä¾‹ãˆã°ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®å½¹å‰²ãŒç®¡ç†è€…ãªã‚‰ã€åŒæ™‚ã«ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚ã‚‹ã‚ã‘ãŒãªã„ã§ã™ã€‚

ãŸã ã€ä¸€éƒ¨ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€userã¨roleã‚’many-to-manyã®é–¢ä¿‚ã§å®šç¾©ã—ã€ãŠäº’ã„ã«è¤‡æ•°æŒã¤ã“ã¨ãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ã€æ’ä»–æ€§ãŒå³å¯†çš„ã§ã¯ãªã„å ´åˆã€many-to-manyã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã¨ã®ã“ã¨ã§ã™ã€‚ä¾‹ãˆã°ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®å½¹å‰²ãŒãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ€ãƒ¼ã¨åŒæ™‚ã«ã€ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã®ä¸€å“¡ã§ã‚‚ã‚ã‚‹ã¨ã‹ã€VIPãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒæ™‚ã«ãƒ¡ãƒ³ãƒãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚ã‚ã‚‹ãªã©ã®ä¾‹ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

æ¬¡ã«ãƒ­ãƒ¼ãƒ«ã¨æ¨©é™ã®é–¢ä¿‚ã¯many-to-manyã«ãªã£ã¦ã„ã¾ã™ã€‚ãƒ­ãƒ¼ãƒ«ã«ã¯è¤‡æ•°ã®æ¨©é™ã‚’æŒã¤ã“ã¨ãŒå¯èƒ½ã§ã‚ã‚‹åŒæ™‚ã«ã€æ¨©é™ã‚‚è¤‡æ•°ã®ãƒ­ãƒ¼ãƒ«ã«å±ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ã€‚ãã®ãŸã‚ã€ä»²ä»‹å½¹ã®pivotãƒ†ãƒ¼ãƒ–ãƒ«ãŒå¿…è¦ã«ãªã£ã¦ãã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒ ã‚­ãƒ¼ãŒäºŒã¤ã®å¤–éƒ¨ã‚­ãƒ¼ã‹ã‚‰ã®è¤‡åˆã‚­ãƒ¼ã¨ãªã‚Šã¾ã™ï¼š

```php
 Schema::create('roles_permissions', function (Blueprint $table) {
      $table->unsignedTinyInteger('role_id');
      $table->unsignedSmallInteger('permission_id');

      $table->foreign('role_id')->references('id')->on('roles')->onDelete('cascade');
      $table->foreign('permission_id')->references('id')->on('permissions')->onDelete('cascade');

      $table->primary(['role_id', 'permission_id']);
});
```

ã“ã®é–¢ä¿‚æ€§ã‚’ã¯ã£ãã‚Šã¨ã™ã‚Œã°ã€ã“ã‚Œã‹ã‚‰ã®å®Ÿè£…ãŒæ¥½ã«ãªã‚Šã¾ã™ã€‚

### Eloquentã§é–¢ä¿‚æ€§ã‚’è¡¨ã™

éå¸¸ã«å¤§äº‹ã§ã‹ã¤è‹¥å¹²è¤‡é›‘ãªéƒ¨åˆ†ã¨ãªã‚Šã¾ã™ãŒã€æ­£ã—ãé–¢ä¿‚ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã€æ¨©é™ã‹ã‚‰è©²å½“æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ãƒ­ãƒ¼ãƒ«ã®å–å¾—ã¨é€†ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã¯`Role.php`ãƒ¢ãƒ‡ãƒ«ã«æ¬¡ã®é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™:

```php

public function permissions()
{
    return $this->belongsToMany(Permission::class, 'roles_permissions', 'role_id', 'permission_id');
}

public function hasPermission(String $permission)
{
    return (bool) $this->permissions->where('name', $permission)->count();
}

```

`hasPermission`ã‚‚ã¤ã„ã§ã«è¿½åŠ ã—ã¦ã€`$role->hasPermission('permission-name')`ã§é‹ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

ãã—ã¦`Permission.php`ãƒ¢ãƒ‡ãƒ«ã«ã‚‚ï¼š

```php
public function roles()
{
    return $this->belongsToMany(Role::class, 'roles_permissions', 'permission_id', 'role_id');
}

```

ã“ã‚Œã§`$permission->roles`ã¨`$role->permissions`ã§é‹ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ã„ãšã‚Œã®`Permission`ã¾ãŸã¯`Role`ã§ã€å±ã—ã¦ã„ã‚‹`Role`ã¾ãŸã¯`Permission`ã‚’å–å¾—ã€‚

ã•ã‚‰ã«`User.php`ã«`hasRole`ã¨`hasPermission`ã®åˆ¤æ–­ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```php

public function role()
{
    return $this->belongsTo(Role::class);
}

public function hasRole(String|int $role)
{
    return ($this->role->name == $role) || ($this->role->id == $role);
}

public function hasPermission(String $permission)
{
    return (bool) $this->role->permissions->where('name', $permission)->count();
}

```

### æ¨©é™ã‚’æ“ä½œã™ã‚‹ãƒˆãƒ¬ã‚¤ãƒˆ

é–¢ä¿‚æ€§ã‚’å®šç¾©ã—ãŸä¸Šã§ã€æ¨©é™ã‚’ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ãƒ»å½¹å‰²ã«ä»˜ä¸ãƒ»å‰¥å¥ªãƒ»ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚ç›´æ¥`Role.php`ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ã®ã‚‚å¯èƒ½ã ãŒã€ã“ã“ã¯ä¸€ã¤ã®traitã¨ã—ã¦æŠ½å‡ºã—ã¾ã™ã€‚

```php
namespace App\Models\Traits;

use App\Models\Permission;

trait ChangePermissions
{
    public function givePermissions(array $permissions)
    {
        $permissions = $this->getPermissions($permissions);
        if ($permissions->isEmpty()) return $this;

        foreach ($permissions as $perm) {
            if (!$this->hasPermission($perm->name)) {
                $this->permissions()->attach($perm->id);
            }
        }
        return $this;
    }

    public function removePermissions(array $permissions)
    {
        $permissions = $this->getPermissions($permissions);
	if ($permissions->isEmpty()) return $this;
	
        foreach ($permissions as $perm) {
            if ($this->hasPermission($perm->name)) {
                $this->permissions()->detach($perm->id);
            }
        }
        return $this;
    }

    public function refreshPermissions(array $permissions)
    {
        $this->permissions()->detach();
        return $this->givePermissions($permissions);
    }

    protected function getPermissions(array $permissions)
    {
        return Permission::whereIn('name', $permissions)->get();
    }
}

```

æ¨©é™ã®ä»˜ä¸ã¯`attach`ã€å‰¥å¥ªã¯`detach`ã§ã€pivotãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã¾ãŸã¯å‰Šé™¤ã—ã¾ã™ã€‚ã“ã“ã§å…ˆã«ã™ã§ã«å­˜åœ¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ãªã„ã¨ã€pivotãƒ†ãƒ¼ãƒ–ãƒ«ã¸é‡è¤‡ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã™ã‚‹ã“ã¨ã«ãªã‚Šã€PKã®åˆ¶ç´„ã«å¼•ã£ã‹ã‹ã‚Šã€ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

è¦æ³¨æ„ã™ã‚‹ã®ã¯`refreshPermissions`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚æœ€åˆã¯ã“ã‚Œã§æ¨©é™ã®æ›´æ–°ãŒæ¥½ã ã¨æ€ã„ã¾ã—ãŸãŒã€`detach`ã§è©²å½“ãƒ­ãƒ¼ãƒ«ã®æŒã¤å…¨ã¦ã®æ¨©é™ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ã—ã¾ã„ã€ãã®éƒ½åº¦æ–°ã—ã„idã‚’æŒã¤æ¨©é™ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦DBã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ãã®ãŸã‚ã€ã“ã‚Œã‚’ä½¿ã†ã¨ã€æ›´æ–°ãŒé€²ã‚€ã«ã¤ã‚Œã€æ¨©é™ãƒ†ãƒ¼ãƒ–ãƒ«ã®idãŒã©ã‚“ã©ã‚“å¢—ãˆã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚å®Ÿéš›ã«æ¨©é™ã®æ›´æ–°ã™ã‚‹ã«ã¯ã€`give`ã¨`remove`ã®æ–¹ãŒç„¡é›£ã ãŒã€ã¨ã‚Šã‚ãˆãšæ©Ÿèƒ½ã¨ã—ã¦æ®‹ã—ã¦ãŠãã¾ã™ã€‚

```php
// Role.php
// ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã«å°å…¥
use ChangePermissions;
```

ã“ã‚Œã§ä»»æ„ã®roleã«`$role->givePermissions($permissions)`ã€`$role->removePermissions($permissions)`ã¨ã‹ã§æ“ä½œå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## æ¨©é™æ©Ÿèƒ½å¿œç”¨

### æ¨©é™é–¢é€£ã®ã‚²ãƒ¼ãƒˆã‚’å®šç¾©

ã“ã‚Œã§äº‹å‰æº–å‚™ã¯å¤§ä½“ã§ãã¾ã—ãŸã€‚ä»Šå›ã®æ¨©é™ã®å¿œç”¨ã¨ã„ãˆã°å¤§ä½“2ã¤ï¼š

- ãƒ«ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ä¿è­·
- ç”»é¢è¡¨ç¤ºå†…å®¹ä¿è­·

ã“ã“ã§Laravelã®ã‚²ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã‚²ãƒ¼ãƒˆã¨è¨€ã‚ã‚Œã¦ãƒ”ãƒ³ã¨ã“ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€`can('permission')`ã¨ã„ã†ä½¿ã„æ–¹ãŒè¦‹ã‹ã‘ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ã“ã‚Œã¯ã¾ã•ã«ã‚²ãƒ¼ãƒˆã§ã™ã€‚ã‚²ãƒ¼ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä½•ã‹ã®æ“ä½œã‚’ã™ã‚‹ãŸã‚ã®ã€Œæ¨©é™ã€ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’`true/false`ã®åˆ¤æ–­ã‚’ã—ã¾ã™ã€‚ã“ã®åˆ¤æ–­çµæœã‚’ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨ã—ã¦ã€ã‚¢ãƒ—ãƒªå…¨ä½“ã«è¡Œãæ¸¡ã‚‹ã“ã¨ã«ãªã‚‹ãŸã‚ã€`can('permission')`ãŒã‚ã¡ã“ã¡ã«ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€ä»Šå›ã®ç›®çš„ã®ç”»é¢å†…å®¹ã®ä¿è­·ã¨ãƒ«ãƒ¼ãƒˆä¿è­·ä¸¡æ–¹ã«ä½¿ãˆã¾ã™ã®ã§ã€ã“ã“ã¯ã¾ãšã‚²ãƒ¼ãƒˆã‚’å®šç¾©ã—ã¾ã™ã€‚

```shell
php artisan make:provider PermissionsServiceProvider
```

```php
class PermissionsServiceProvider extends ServiceProvider
{
    public function boot()
    {
        try {
            Permission::get()->map(function ($perm) {
                Gate::define($perm->name, function ($user) use ($perm) {
                    return $user->hasPermission($perm->name);
                });
            });
        } catch (\Exception $e) {
            Log::error(__FILE__ . " (" . __LINE__ . ")" . PHP_EOL . $e->getMessage());
            return false;
        }

        Blade::directive('role', function ($role) {
            return "if(auth()->check() && auth()->user()->hasRole({$role})) :";
        });

        Blade::directive('endrole', function ($role) {
            return "endif;";
        });
    }
}

```

ã‚²ãƒ¼ãƒˆãƒ•ã‚¡ã‚µãƒ¼ãƒ‰ã§ã€æ¨©é™ã®åå‰ã‚’æŒã£ã¦ãã‚Œãã‚Œå®šç¾©ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãã®æ¨©é™ã‚’æŒã¤ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚è¦æ³¨æ„ã™ã‚‹ã®ã¯ã€ã‚²ãƒ¼ãƒˆã§å®šç¾©ã—ãŸã€Œæ¨©é™ã€ã¨ã„ã†ã®ã¯å‰ç¯€ã§ä½œã£ãŸPermission/æ¨©é™ã¨ã¯é•ã„ã¾ã™ãŒã€å‰ç¯€ã§ä½œã£ãŸPermission/æ¨©é™ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚ç†è«–ä¸Šã€Permissionãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã‚‰ãªãã¦ã‚‚ã€ã‚²ãƒ¼ãƒˆã ã‘ã‚’å®šç¾©ã—ã¦ã‚‚`can('permission')`ã®æ©Ÿèƒ½ã¯å®Ÿç¾å¯èƒ½ã§ã™ï¼ˆãŸã ãŠã™ã™ã‚ã¯ã—ã¾ã›ã‚“ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®æ‚ªå¤¢ã¯è¦‹ãˆè¦‹ãˆã§ã™ï¼‰ã€‚

ã¾ãŸã€ã“ã“ã§ã‚«ã‚¹ã‚¿ãƒ ã®å‘½ä»¤(directive)`role`ã‚’å®šç¾©ã™ã‚‹ã¨ã€ãƒ–ãƒ¬ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€`@role('role_id')...@endrole`ã®å½¢ã§ä½¿ãˆã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½¹å‰²ã§ä¸€æ‹¬ã§åˆ¤æ–­ã™ã‚‹å ´åˆã¨ã€æ¨©é™æ¯ã«åˆ¤æ–­ã™ã‚‹å ´åˆã®ä½¿ã„åˆ†ã‘ã«ãªã‚Šã¾ã™ã€‚

æœ€å¾Œã«ä½œå‹•ã•ã›ã‚‹ãŸã‚ã«ã€ã“ã¡ã‚‰ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’`config\app.php`ã«ç™»éŒ²ã—ã¾ã™ï¼š

```php
'providers' => [
    //...
    App\Providers\PermissionsServiceProvider::class,
],
```

### ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ãƒ«ãƒ¼ãƒˆä¿è­·

ã“ã‚Œã§ã‚ˆã†ã‚„ãã€å…¨ã¦ã®æº–å‚™ãŒæ•´ãˆã¾ã—ãŸã€‚

ã¾ãšã¯ãƒ«ãƒ¼ãƒˆä¿è­·ã®å¿œç”¨ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ãƒ«ãƒ¼ãƒˆä¿è­·ã®ãŸã‚ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½œã‚Šã¾ã™ï¼š

```shell
php artisan make:middleware PermissionMiddleware
```

```php
class PermissionMiddleware
{
    public function handle($request, Closure $next, $permission = null)
    {
        if ($permission !== null && !$request->user()->can($permission)) {
            abort(403);
        }

        return $next($request);
    }
}

```

ã‚²ãƒ¼ãƒˆã®å®šç¾©ã«ã‚ˆã‚Šã€`can('permission-name')`ã®å½¢ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã®ã§ã€ä¿è­·ã—ãŸã„ãƒ«ãƒ¼ãƒˆã«æ¨©é™ã®åå‰ã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã›ã°æ©Ÿèƒ½ã—ã¾ã™ã€‚ã“ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã€`$permission`ã¨ã„ã†å¼•æ•°ã‚’å—ã‘å–ã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©²å½“æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã«ã‚ˆã‚Šã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¶šã‘ã‚‹ã‹ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‹ã‚’æ±ºã‚ã¾ã™ã€‚

ã¤ã¾ã‚Šã€`web.php`ã¨ã‹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«æ¬¡ã®ã‚ˆã†ã«ä½¿ãˆã¾ã™ï¼š

```php
Route::group(['middleware' => 'permission:view-users'], function () {
       Route::get('/users', [UserController::class,'index'])->name('user.index');
       Route::post('/users', [UserController::class,'store']);
       Route::get('/users/{id}', [UserController::class,'show'])->name('user.show');
});
```

`view-users`ã®æ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚ã¡ãªã¿ã«ã€è¤‡æ•°ã®å¼•æ•°ã‚’æ¸¡ã™ã®ã§ã‚ã‚Œã°ã€`...$permission`ã§å®šç¾©ã—ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã‚³ãƒ³ãƒã‚’ã¤ã‘ã¦ã€`'permission:perm1,perm2,...`ã®å½¢ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

ã‚‚ã¡ã‚ã‚“ã€ä½œå‹•ã•ã›ã‚‹ãŸã‚ã«ã€`App\Http\Kernel.php`ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ç™»éŒ²ã‚‚å¿˜ã‚Œãšã«ã€‚

```php
protected $routeMiddleware = [
    // ...
    'permission' => \App\Http\Middleware\PermissionMiddleware::class,
];
```

### ãƒ–ãƒ¬ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ä¿è­·

æœ€å¾Œã¯å†…å®¹ä¿è­·ã§ã™ãŒã€ã“ã¡ã‚‰ã‚‚ç°¡å˜ã«ä½¿ãˆã¾ã™ã€‚ä¾‹ãˆã°ï¼š

```html
@canany(['view-users', 'view-items'])
  <ul class="nav flex-column nav-pills">
    @can('view-users')
      <li class="nav-item">
        ...
      </li>
    @endcan
    @can('view-items')
      <li class="nav-item">
	...
      </li>
    @endcan
  </ul>
@endcan
```

ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆã§ã™ã­ã€‚

## æ¨©é™ç®¡ç†ç”»é¢

### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ã“ã‚Œã¾ã§ã«ã‚³ã‚¢ãªéƒ¨åˆ†ã¯å®Ÿè£…ã§ãã¾ã—ãŸã€‚æœ€å¾Œã¯æ¨©é™ã‚’ç®¡ç†ã§ãã‚‹ç”»é¢ã‚’ä½œã‚Šã¾ã™ã€‚ã¾ãšã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚ã“ã“ã§å°‘ãªãã¨ã‚‚3ã¤ã®ãƒ«ãƒ¼ãƒˆã¨ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ï¼š

- ç”»é¢è¡¨ç¤º
- ãƒ­ãƒ¼ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã³ã«è©²å½“ãƒ­ãƒ¼ãƒ«ã®æ¨©é™ã‚’å–å¾—
- å¤‰æ›´å¾Œã®å†…å®¹ã‚’ä¿å­˜ã™ã‚‹

ã¾ãšã¯ãƒ«ãƒ¼ãƒˆã‚’ã¤ã‘ã¦ã¿ã‚‹ã¨ï¼š

```php
Route::group(['middleware' => 'permission:view-permission'], function () {
	Route::get('/permission', [PermissionController::class, 'index'])->name('perm.index');
	Route::post('/permission', [PermissionController::class, 'store']);
	Route::get('/permission/{role_id}', [PermissionController::class, 'getPerms']);
});
```

æ¬¡ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ›¸ãã¾ã™ã€‚ä»Šå›ã®æ¨©é™å–å¾—ã¨å†…å®¹ä¿å­˜ã‚’éåŒæœŸå‡¦ç†ã«ã—ã¾ã™ã€‚

```php
class PermissionController extends Controller
{
    public function index(Request $request)
    {
        $perms = Permission::all();
	$roles = Role::all();
        return view('permission', compact('perms','roles'));
    }

    public function store(Request $request)
    {
        $response = ['status' => 0];

        if (!$request->has('role_id')) {
            $response['msg'] =  'ãƒ¦ãƒ¼ã‚¶ãƒ¼å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';
            return Response()->json($response);
        }

        try {
            $role = Role::find($request->get('role_id'));
	    $data = $request->except(['role_id','_token']);
	    
	    // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„é …ç›®ã¯ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ãƒã‚¹ãƒˆã•ã‚Œãªã„
            $all_perms = Permission::pluck('name')->toArray();
            $checked = array_keys($data);
            $unchecked = array_values(array_diff($all_perms, $checked));
	    
	    // idãŒç„¡é§„ã«å¢—ãˆã‚‹å•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã«refreshPermissionã‚’ä½¿ç”¨ã—ãªã„
            $role->givePermissions($checked);
            $role->removePermissions($unchecked);
        } catch (\Exception $e) {
            Log::error(__FILE__ . " (" . __LINE__ . ")" . PHP_EOL . $e->getMessage());
            $response['msg'] =  'å¤‰æ›´ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚';
            return Response()->json($response);
        }

        $response['msg'] =  'å¤‰æ›´ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚';
        $response['status'] = 1;
        return Response()->json($response);
    }

    public function getPerms(Request $request, $role_id)
    {
        $response = ['status' => 0];

        $role = Role::find($role_id);
        if (is_null($role)) {
            $response['msg'] = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å½¹å‰²ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚';
            return Response()->json($response);
        }

        $response['msg'] = 'æ¨©é™ã‚’å–å¾—ã§ãã¾ã—ãŸã€‚';
        $response['status'] = 1;
        $response['data'] = ['perms' => $role->permissions->pluck('name')];
        return Response()->json($response);
    }
}
```

### ãƒ–ãƒ¬ãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼

æ¬¡ã«ãƒ“ãƒ¥ãƒ¼ã®éƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚bootstrapä½¿ç”¨ã®ä¸€ä¾‹ã¨ã—ã¦ï¼š

```php
@section('content')
  <div class="container">
    <form id="permissionForm" method="post" enctype="multipart/form-data">
      @csrf
      <div class="form-group row align-items-center">
        <div class="col-md-2">
          <h5 class="mb-0 align-middle">
            <span class="badge badge-secondary px-2 py-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼å½¹å‰²</span>
          </h5>
        </div>
        <div class="col-md-8 d-flex justify-content-around">
          <select class="custom-select" name="role_id" id="roleId">
            <option disabled selected>é¸æŠã—ã¦ä¸‹ã•ã„</option>
	    @foreach ($roles as $role)
	ã€€    <option value="{{$role->id}}">{{$role->name}}</option>
	    @endforeach
          </select>
        </div>
        <div class="col-md-2 text-center">
          <button class="btn btn-primary" id="saveBtn" type="submit" disabled>ä¿å­˜</button>
        </div>
      </div>

      <div class="col-md-12 px-0" id="permissionTable" hidden>
        <table class="table table-hover">
          <thead class="thead-light">
            <tr>
              <th class="text-nowrap" scope="col">&nbsp;</th>
              <th class="text-nowrap" scope="col">æ¨©é™å</th>
              <th class="text-nowrap text-center" scope="col">ä»˜ä¸</th>
            </tr>
          </thead>
          <tbody>
            @foreach ($perms as $perm)
              <tr scope="row">
                <td class="text-center">{{ $loop->iteration }}</td>
                <td class="text-nowrap">
                  {{ $perm->name }}
                </td>
                <td class="text-nowrap text-center">
                  <label for="{{ $perm->name }}" class='w-100'>
                    <input type="checkbox" name="{{ $perm->name }}" id="{{ $perm->name }}">
                  </label>
                </td>
              </tr>
            @endforeach
          </tbody>
        </table>
      </div>
    </form>
  </div>
@endsection
@section('scripts')
  <script src="{{ asset('js/perm.js') }}" defer></script>
@endsection
```

ã“ã“ã§`input`ã®`name`å±æ€§ã‚’å…¨éƒ¨æ¨©é™ã®åå‰ã«ã—ã¦ã„ã¾ã™ã€‚ç†ç”±ã¯ä¾¿åˆ©ã ã‘ã§ã™ãŒã€åˆ¥ã«idã¨ã‹ã«ã—ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

å¤§ä½“ã®ç”»é¢ã¯ã“ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™ï¼š

![](https://storage.googleapis.com/zenn-user-upload/b0458337eec1d2d04ca56e18.png)

### JSãƒ•ã‚¡ã‚¤ãƒ«

æœ€å¾Œã¯éåŒæœŸå‡¦ç†ã‚’JSãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã€ãƒ–ãƒ¬ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã«å°å…¥ã—ã¾ã™ã€‚

```javascript
$(function () {

  const csrfHeader = {
    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content'),
  }

  const jsonHeader = {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
    ...csrfHeader,
  }

  $('#roleId').change(async (e) => {
    let roleId = $('#roleId').val()
    if (!roleId) return

    resetCheckBox()
    toggleBtnAndCheckbox(true)
    $('#permTable').attr('hidden', false)

    const url = `permission/${roleId}`
    try {
      const res = await fetch(url, {
        method: 'GET',
        headers: jsonHeader,
      })

      const { status, msg } = await res.json()
      if (status) {
        const { perms } = data['data']
        for (const perm of perms) {
          $(`#${perm}`).prop('checked', true)
        }
      } else {
        showMsg(msg, status)
      }
    } catch (err) {
      console.log(err)
    } finally {
      toggleBtnAndCheckbox(false)
    }
  })

  $('#permissionForm').submit(async (e) => {
    e.preventDefault()
    toggleBtnAndCheckbox(true)
    
    const formData = new FormData(e.currentTarget)
    const url = window.location.href
    
    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: csrfHeader, // æ³¨æ„ï¼šjsonHeaderä½¿ã†ã¨formDataãŒå–å¾—ã§ãã¾ã›ã‚“
        body: formData
      })

      const { status, msg } = await res.json()
      showMsg(msg, status)
    } catch (err) {
      console.log(err)
    } finally {
      toggleBtnAndCheckbox(false)
    }
  })

  function resetCheckBox() {
    $('input:checkbox').prop('checked', false)
  }

  function toggleBtnAndCheckbox(status) {
    $('#saveBtn').prop('disabled', status)
    $('input:checkbox').prop('disabled', status)
  }

  function showMsg(msg, status) {
    let label = status ? "danger" : "success"
    let msgEl = `
          <div class="alert alert-${label} alert-dismissable" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true" >
              &times;
            </button>
            ${msg}
          </div>
          `
    $(".message-area").append(msgEl).hide().slideDown(500, 0).fadeIn(1000, 0)
    setTimeout(() => {
      $(".alert")
        .fadeTo(500, 0)
        .slideUp(600, function () {
          $(this).remove()
        })
    }, 3000)
  }
})
```

å‰ã‹ã‚‰çµæ§‹æ¨©é™ç®¡ç†ã«ã¤ã„ã¦æ°—ã«ãªã£ã¦ã„ã¦ã€ä»Šå›ã‚’æ©Ÿã«ã€MVCã‚’å«ã‚ã¦ã€æ¨©é™ç®¡ç†ã®å®Ÿè£…ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚Laravelã®Eloquent Relationship, Gateãªã©ã®ä¾¿åˆ©ãªæ©Ÿèƒ½ã®ãŠã‹ã’ã§ã€ã‚³ã‚¢ãªéƒ¨åˆ†ã¯ã‹ãªã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ãƒ“ãƒ¥ãƒ¼ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®å®Ÿè£…ã‚‚ç°¡å˜ã«ãªã‚Šã¾ã™ã€‚ã‚„ã¯ã‚ŠLaravelã¯ç´ æ™´ã‚‰ã—ã„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã­ã€‚

ä»¥ä¸Šã§ã™ï¼